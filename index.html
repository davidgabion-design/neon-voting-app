﻿﻿﻿﻿﻿<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Neon Voting System</title>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <style>
    :root{
      --bg:#0b1020;
      --card:#111a33;
      --card2:#0f1730;
      --border: rgba(0,255,255,.14);
      --text:#eaf2ff;
      --muted:#9bb2d0;
      --primary:#9D00FF;
      --secondary:#00C3FF;
      --accent:#00ffaa;
      --danger:#ff4b4b;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 500px at 20% 15%, rgba(157,0,255,.25), transparent 60%),
        radial-gradient(900px 500px at 85% 20%, rgba(0,195,255,.18), transparent 60%),
        radial-gradient(900px 500px at 50% 95%, rgba(0,255,170,.10), transparent 60%),
        var(--bg);
      min-height:100vh;
    }
    .app{
      width:min(1100px, 92vw);
      margin:0 auto;
      padding:26px 0 60px;
    }
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      margin-bottom:18px;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
    }
    .logo{
      width:44px;height:44px;border-radius:14px;
      background: linear-gradient(135deg, rgba(157,0,255,.9), rgba(0,195,255,.9));
      box-shadow: 0 12px 30px rgba(0,0,0,.35);
      display:grid; place-items:center;
      border:1px solid rgba(255,255,255,.12);
    }
    .logo i{color:white}
    h1{margin:0;font-size:20px;letter-spacing:.2px}
    .subtitle{margin:2px 0 0;color:var(--muted);font-size:12px}

    /* Screens */
    .screen{display:none; animation: fadeIn .25s ease;}
    .screen.active{display:block;}
    @keyframes fadeIn{from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:translateY(0)}}

    .card{
      background: linear-gradient(180deg, rgba(17,26,51,.92), rgba(15,23,48,.92));
      border:1px solid var(--border);
      border-radius:18px;
      padding:16px;
      box-shadow: 0 20px 60px rgba(0,0,0,.45);
    }
    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:14px;
    }
    .col-12{grid-column: span 12;}
    .col-6{grid-column: span 6;}
    @media (max-width:900px){ .col-6{grid-column: span 12;} }

    .btn{
      cursor:pointer;
      border:none;
      padding:11px 14px;
      border-radius:14px;
      font-weight:700;
      letter-spacing:.2px;
      display:inline-flex; align-items:center; justify-content:center;
      gap:10px;
      color:var(--text);
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      transition:all 0.2s ease;
    }
    .btn:hover{filter:brightness(1.06); transform:translateY(-1px)}
    .btn:active{transform:translateY(0)}
    .btn-block{width:100%}
    .neon-btn{
      background: linear-gradient(135deg, rgba(157,0,255,.95), rgba(0,195,255,.95));
      border:1px solid rgba(255,255,255,.12);
      box-shadow: 0 10px 26px rgba(157,0,255,.18);
    }
    .neon-btn-outline{
      background: transparent;
      border:1px solid rgba(0,195,255,.35);
    }
    .neon-btn-lg{padding:13px 14px; border-radius:16px;}
    .label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px}
    .input{
      width:100%;
      padding:11px 12px;
      border-radius:14px;
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
      color:var(--text);
      outline:none;
      transition:border-color 0.2s, box-shadow 0.2s;
    }
    .input:focus{border-color: rgba(0,255,255,.35); box-shadow: 0 0 0 4px rgba(0,195,255,.08);}
    .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    .subtext{color:var(--muted); font-size:12px; line-height:1.45}
    .section-title{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px}
    .badge{
      font-size:11px; padding:4px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      color: var(--muted);
      white-space:nowrap;
    }
    
    .badge.success{background: rgba(0,255,170,.12); border-color: rgba(0,255,170,.35); color: var(--accent)}
    .badge.warning{background: rgba(255,200,50,.12); border-color: rgba(255,200,50,.35); color: #ffc832}
    .badge.danger{background: rgba(255,75,75,.12); border-color: rgba(255,75,75,.35); color: var(--danger)}
    .badge.info{background: rgba(0,195,255,.12); border-color: rgba(0,195,255,.35); color: var(--secondary)}
    .badge.primary{background: rgba(157,0,255,.12); border-color: rgba(157,0,255,.35); color: var(--primary)}

    /* Tabs */
    .tabs{display:flex; flex-wrap:wrap; gap:10px; margin:10px 0 0}
    .tab-btn{
      padding:9px 12px; border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      cursor:pointer;
      color: var(--text);
      font-weight:700;
      font-size:12px;
      display:inline-flex; align-items:center; gap:8px;
      transition:all 0.2s ease;
    }
    .tab-btn:hover{background: rgba(255,255,255,.08)}
    .tab-btn.active{
      background: linear-gradient(135deg, rgba(157,0,255,.40), rgba(0,195,255,.22));
      border-color: rgba(0,255,255,.25);
    }

    /* Toast mount */
    #toastContainer{
      position: fixed;
      right: 16px;
      bottom: 16px;
      z-index: 9999;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
  
    /* Voter Redesign */
    .form-grid{display:grid;gap:12px}
    .form-group{display:flex;flex-direction:column;gap:6px}
    .form-group label{font-size:12px;color:var(--muted);font-weight:700}
    .form-group input{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color: var(--text);
      outline:none;
    }
    .form-group input:focus{border-color: rgba(0,255,255,.35); box-shadow:0 0 0 4px rgba(0,195,255,.10)}
    .error-text{margin-top:10px;color: var(--danger);font-weight:700;font-size:12px;display:none}
    .vote-progress{
      display:flex;align-items:center;justify-content:space-between;
      gap:12px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      margin: 6px 0 14px;
      color: var(--muted);
      font-size:12px;
      font-weight:700;
    }
    .candidate-card{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      border-radius:16px;
      padding:12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      cursor:pointer;
      margin-bottom:10px;
      transition:.15s ease;
    }
    .candidate-card:hover{border-color: rgba(0,255,255,.28); filter: brightness(1.04)}
    .candidate-card.selected{
      border-color: rgba(0,255,170,.65);
      box-shadow: 0 0 0 4px rgba(0,255,170,.08), 0 10px 26px rgba(0,255,170,.08);
    }
    .candidate-meta{display:flex;flex-direction:column;gap:2px;min-width:0}
    .candidate-name{font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .candidate-sub{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .vote-actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .vote-actions .btn{flex:1 1 180px}
    .review-item{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      margin-bottom:10px;
    }
    .review-item .k{font-weight:800;color:var(--text)}
    .review-item .v{color:var(--muted);font-size:12px;text-align:right;max-width:60%}

    /* Approval System Styles */
    .checklist {
      list-style: none;
      padding: 0;
      margin: 12px 0;
    }
    .checklist li {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 0;
      font-size: 13px;
      color: var(--muted);
    }
    .checklist li::before {
      content: "❌";
    }
    .checklist li.checked::before {
      content: "✅";
      color: var(--accent);
    }
    .checklist li.checked {
      color: var(--accent);
    }

    /* Approval Status Cards */
    .status-card {
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 14px;
      padding: 14px;
      margin-bottom: 12px;
      background: rgba(255,255,255,.03);
    }
    .status-card.approved {
      border-color: rgba(0,255,170,.35);
      background: rgba(0,255,170,.06);
    }
    .status-card.pending {
      border-color: rgba(255,200,50,.35);
      background: rgba(255,200,50,.06);
    }
    .status-card.rejected {
      border-color: rgba(255,75,75,.35);
      background: rgba(255,75,75,.06);
    }

    /* Modal overlay */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      padding: 20px;
    }
    .modal-overlay.active {
      display: flex;
    }
    .modal-content {
      background: var(--card);
      border-radius: 18px;
      border: 1px solid var(--border);
      padding: 20px;
      width: min(500px, 90vw);
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 30px 80px rgba(0,0,0,.5);
    }

    /* Loading spinner */
    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(255,255,255,.1);
      border-top-color: var(--secondary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Loading overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }
    
    .loading-overlay.active {
      display: flex;
    }
    
    /* Password error styling */
    .password-error {
      color: var(--danger);
      font-size: 12px;
      margin-top: 8px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
      opacity: 0;
      transform: translateY(-5px);
      transition: opacity 0.3s, transform 0.3s;
    }
    
    .password-error.show {
      opacity: 1;
      transform: translateY(0);
    }
    
    .input-error {
      border-color: rgba(255, 75, 75, 0.6) !important;
      box-shadow: 0 0 0 4px rgba(255, 75, 75, 0.15) !important;
    }
    
    /* Super Admin Login Specific */
    .super-login-container {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 70vh;
      padding: 20px;
    }

    .super-login-card {
      width: 100%;
      max-width: 500px;
      padding: 30px;
      border-radius: 22px;
      background: linear-gradient(
        135deg,
        rgba(20, 30, 60, 0.85),
        rgba(10, 15, 35, 0.85)
      );
      border: 1px solid rgba(157, 0, 255, 0.25);
      box-shadow: 0 30px 80px rgba(0, 0, 0, 0.55);
      backdrop-filter: blur(14px);
    }

    .super-login-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
    }

    .super-login-title {
      margin: 0;
      font-size: 22px;
      font-weight: 800;
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--primary);
    }

    .super-login-sub {
      margin-top: 6px;
      font-size: 13px;
      color: var(--muted);
    }

    .super-login-back {
      background: rgba(255, 255, 255, 0.06);
      border: 1px solid rgba(157, 0, 255, 0.25);
      color: var(--text);
      padding: 10px 16px;
      border-radius: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
    }

    .super-login-body {
      margin-top: 20px;
    }

    .super-login-label {
      display: block;
      font-size: 13px;
      margin-bottom: 8px;
      color: var(--muted);
      font-weight: 600;
    }

    .super-login-input {
      width: 100%;
      padding: 16px;
      font-size: 15px;
      border-radius: 16px;
      border: 1px solid rgba(157, 0, 255, 0.3);
      background: rgba(255, 255, 255, 0.05);
      color: var(--text);
      letter-spacing: 2px;
      font-family: monospace;
    }

    .super-login-input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(157, 0, 255, 0.15);
      outline: none;
    }

    .super-login-btn {
      margin-top: 24px;
      width: 100%;
      padding: 16px 26px;
      font-size: 15px;
      font-weight: 800;
      border-radius: 18px;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      color: white;
      background: linear-gradient(
        135deg,
        rgba(157, 0, 255, 1),
        rgba(0, 195, 255, 0.9)
      );
      transition: transform 0.2s;
    }

    .super-login-btn:hover {
      transform: translateY(-2px);
    }

    .super-login-btn:active {
      transform: translateY(0);
    }

    /* Setup instructions */
    .setup-instructions {
      margin-top: 20px;
      padding: 15px;
      background: rgba(0, 195, 255, 0.08);
      border-radius: 12px;
      border: 1px solid rgba(0, 195, 255, 0.2);
    }
    
    .setup-instructions h4 {
      margin: 0 0 10px 0;
      color: var(--secondary);
    }
    
    .setup-instructions code {
      background: rgba(0, 0, 0, 0.3);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
    }
    
    /* EC Content containers */
    .ec-content {
      margin-top: 14px;
    }
    
    /* Results and Outcomes Styling */
    .outcome-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
      margin: 16px 0;
    }
    
    .stat-card {
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 14px;
      padding: 16px;
      text-align: center;
    }
    
    .stat-value {
      font-size: 24px;
      font-weight: 800;
      margin-bottom: 4px;
      color: var(--accent);
    }
    
    .stat-label {
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .position-result {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 16px;
    }
    
    .position-title {
      font-size: 16px;
      font-weight: 800;
      margin: 0 0 12px 0;
      color: var(--secondary);
    }
    
    .candidate-result {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      background: rgba(255, 255, 255, 0.02);
      border-radius: 12px;
      margin-bottom: 8px;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .candidate-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    
    .vote-bar {
      height: 8px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      margin: 6px 0;
      overflow: hidden;
    }
    
    .vote-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      border-radius: 4px;
      transition: width 1s ease-out;
    }
    
    .vote-count {
      font-size: 12px;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      margin-top: 4px;
    }
    
    .winner-badge {
      background: rgba(0, 255, 170, 0.12);
      color: var(--accent);
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 10px;
      font-weight: 700;
      margin-left: 8px;
    }
    
    /* Real-time updates indicator */
    .real-time-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: rgba(0, 195, 255, 0.08);
      border: 1px solid rgba(0, 195, 255, 0.2);
      border-radius: 12px;
      margin-bottom: 16px;
    }
    
    .pulse-dot {
      width: 8px;
      height: 8px;
      background: var(--accent);
      border-radius: 50%;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    
    /* Super Admin Global Dashboard Styles */
    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 1px solid rgba(255,255,255,.1);
    }
    
    .dashboard-stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 14px;
      margin: 20px 0;
    }
    
    .dashboard-stat-card {
      background: linear-gradient(135deg, rgba(20,30,60,.7), rgba(10,15,35,.7));
      border: 1px solid rgba(157,0,255,.2);
      border-radius: 16px;
      padding: 18px;
      text-align: center;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .dashboard-stat-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 15px 40px rgba(157,0,255,.15);
      border-color: rgba(157,0,255,.4);
    }
    
    .dashboard-stat-value {
      font-size: 32px;
      font-weight: 800;
      margin: 8px 0;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .dashboard-stat-label {
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .dashboard-stat-change {
      font-size: 10px;
      margin-top: 6px;
      padding: 2px 8px;
      border-radius: 999px;
      display: inline-block;
    }
    
    .change-positive {
      background: rgba(0,255,170,.12);
      color: var(--accent);
    }
    
    .change-negative {
      background: rgba(255,75,75,.12);
      color: var(--danger);
    }
    
    .org-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 14px;
      margin-top: 20px;
    }
    
    .org-card {
      background: rgba(255,255,255,.03);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 16px;
      padding: 16px;
      transition: all 0.2s;
    }
    
    .org-card:hover {
      border-color: rgba(0,195,255,.3);
      background: rgba(0,195,255,.03);
    }
    
    .org-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }
    
    .org-name {
      font-weight: 700;
      font-size: 15px;
      margin: 0 0 4px 0;
    }
    
    .org-id {
      font-size: 11px;
      color: var(--muted);
      background: rgba(0,0,0,.3);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: monospace;
    }
    
    .org-metrics {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin: 12px 0;
    }
    
    .org-metric {
      text-align: center;
      padding: 8px;
      background: rgba(255,255,255,.02);
      border-radius: 10px;
    }
    
    .org-metric-value {
      font-weight: 800;
      font-size: 18px;
      margin-bottom: 2px;
    }
    
    .org-metric-label {
      font-size: 9px;
      color: var(--muted);
      text-transform: uppercase;
    }
    
    .activity-timeline {
      margin-top: 20px;
      max-height: 300px;
      overflow-y: auto;
      padding-right: 8px;
    }
    
    .activity-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 12px;
      border-bottom: 1px solid rgba(255,255,255,.05);
    }
    
    .activity-item:last-child {
      border-bottom: none;
    }
    
    .activity-icon {
      width: 32px;
      height: 32px;
      border-radius: 10px;
      background: rgba(157,0,255,.15);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    
    .activity-content {
      flex: 1;
    }
    
    .activity-text {
      font-size: 13px;
      margin: 0 0 4px 0;
    }
    
    .activity-time {
      font-size: 10px;
      color: var(--muted);
    }
    
    .live-charts-container {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 20px;
      margin-top: 20px;
    }
    
    @media (max-width: 768px) {
      .live-charts-container {
        grid-template-columns: 1fr;
      }
    }
    
    .chart-container {
      background: rgba(255,255,255,.02);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 16px;
      padding: 16px;
      height: 300px;
    }
    
    .chart-title {
      font-size: 14px;
      font-weight: 700;
      margin: 0 0 16px 0;
      color: var(--secondary);
    }
    
    .refresh-controls {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: flex-end;
    }
    
    .time-filter {
      display: flex;
      gap: 6px;
      background: rgba(255,255,255,.04);
      padding: 4px;
      border-radius: 10px;
    }
    
    .time-filter-btn {
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 11px;
      background: transparent;
      border: none;
      color: var(--muted);
      cursor: pointer;
    }
    
    .time-filter-btn.active {
      background: rgba(157,0,255,.2);
      color: var(--primary);
    }
    
    /* Data Sync Indicators */
    .sync-indicator {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 10px;
      background: rgba(0,255,170,.1);
      border: 1px solid rgba(0,255,170,.2);
      color: var(--accent);
      margin-left: 8px;
    }
    
    .sync-pulse {
      width: 6px;
      height: 6px;
      background: var(--accent);
      border-radius: 50%;
      animation: pulse 1.5s infinite;
    }
    
    /* Data Management Styles */
    .data-management {
      margin-top: 20px;
      padding: 16px;
      background: rgba(255,255,255,.02);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 16px;
    }
    
    .data-management-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .data-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .data-table th {
      text-align: left;
      padding: 12px;
      border-bottom: 1px solid rgba(255,255,255,.1);
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .data-table td {
      padding: 12px;
      border-bottom: 1px solid rgba(255,255,255,.05);
      font-size: 13px;
    }
    
    .data-table tr:hover {
      background: rgba(255,255,255,.03);
    }
    
    /* Bulk Invite Styles */
    .bulk-invite-container {
      margin-top: 20px;
    }
    
    .bulk-invite-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .bulk-invite-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      border-bottom: 1px solid rgba(255,255,255,.1);
      padding-bottom: 8px;
    }
    
    .bulk-invite-tab {
      padding: 8px 16px;
      border-radius: 10px;
      background: transparent;
      border: none;
      color: var(--muted);
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
    }
    
    .bulk-invite-tab.active {
      background: rgba(157,0,255,.2);
      color: var(--primary);
    }
    
    .bulk-textarea {
      width: 100%;
      min-height: 200px;
      padding: 16px;
      border-radius: 14px;
      background: rgba(255,255,255,.03);
      border: 1px solid rgba(255,255,255,.1);
      color: var(--text);
      font-family: monospace;
      font-size: 13px;
      line-height: 1.5;
      resize: vertical;
    }
    
    .bulk-textarea:focus {
      border-color: rgba(0,255,255,.35);
      box-shadow: 0 0 0 4px rgba(0,195,255,.08);
      outline: none;
    }
    
    .bulk-preview {
      background: rgba(255,255,255,.02);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 14px;
      padding: 16px;
      margin-top: 16px;
      max-height: 300px;
      overflow-y: auto;
    }
    
    .bulk-preview-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px;
      border-bottom: 1px solid rgba(255,255,255,.05);
    }
    
    .bulk-preview-item:last-child {
      border-bottom: none;
    }
    
    .bulk-preview-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: rgba(157,0,255,.2);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    
    .bulk-preview-info {
      flex: 1;
    }
    
    .bulk-preview-name {
      font-weight: 600;
      font-size: 13px;
    }
    
    .bulk-preview-email {
      font-size: 11px;
      color: var(--muted);
    }
    
    .bulk-preview-status {
      font-size: 10px;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(0,255,170,.1);
      color: var(--accent);
    }
    
    .bulk-progress {
      margin-top: 20px;
    }
    
    .bulk-progress-bar {
      height: 8px;
      background: rgba(255,255,255,.1);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 8px;
    }
    
    .bulk-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      border-radius: 4px;
      transition: width 0.3s ease;
    }
    
    .bulk-progress-text {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: var(--muted);
    }
    
    .bulk-actions {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }
    
    /* Template Styles */
    .template-container {
      margin-top: 16px;
    }
    
    .template-card {
      background: rgba(255,255,255,.02);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 14px;
      padding: 16px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .template-card:hover {
      border-color: rgba(0,255,255,.2);
      background: rgba(0,255,255,.03);
    }
    
    .template-card.active {
      border-color: rgba(0,255,170,.35);
      background: rgba(0,255,170,.05);
    }
    
    .template-name {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 4px;
    }
    
    .template-description {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 8px;
    }
    
    .template-stats {
      display: flex;
      gap: 12px;
      font-size: 11px;
      color: var(--muted);
    }
    
    .upload-area {
      border: 2px dashed rgba(255,255,255,.2);
      border-radius: 14px;
      padding: 40px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .upload-area:hover {
      border-color: rgba(0,255,255,.4);
      background: rgba(0,255,255,.03);
    }
    
    .upload-area.dragover {
      border-color: var(--accent);
      background: rgba(0,255,170,.05);
    }
    
    .upload-icon {
      font-size: 32px;
      color: var(--muted);
      margin-bottom: 12px;
    }
    
    .upload-text {
      font-size: 14px;
      margin-bottom: 8px;
    }
    
    .upload-subtext {
      font-size: 12px;
      color: var(--muted);
    }
    
    .file-input {
      display: none;
    }
    
    .selected-file {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: rgba(255,255,255,.03);
      border-radius: 12px;
      margin-top: 16px;
    }
    
    .file-icon {
      font-size: 20px;
      color: var(--secondary);
    }
    
    .file-info {
      flex: 1;
    }
    
    .file-name {
      font-weight: 600;
      font-size: 13px;
    }
    
    .file-size {
      font-size: 11px;
      color: var(--muted);
    }
    
    .remove-file {
      background: rgba(255,75,75,.1);
      border: 1px solid rgba(255,75,75,.2);
      color: var(--danger);
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    
    /* Invite History */
    .invite-history {
      margin-top: 20px;
    }
    
    .history-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .history-table th {
      text-align: left;
      padding: 12px;
      border-bottom: 1px solid rgba(255,255,255,.1);
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .history-table td {
      padding: 12px;
      border-bottom: 1px solid rgba(255,255,255,.05);
      font-size: 13px;
    }
    
    .history-table tr:hover {
      background: rgba(255,255,255,.03);
    }
    
    .invite-status {
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
    }
    
    .status-sent {
      background: rgba(0,195,255,.1);
      color: var(--secondary);
    }
    
    .status-pending {
      background: rgba(255,200,50,.1);
      color: #ffc832;
    }
    
    .status-failed {
      background: rgba(255,75,75,.1);
      color: var(--danger);
    }
    
    /* CSV Preview */
    .csv-preview {
      margin-top: 16px;
      overflow-x: auto;
    }
    
    .csv-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    
    .csv-table th {
      background: rgba(255,255,255,.05);
      padding: 8px;
      border: 1px solid rgba(255,255,255,.1);
      text-align: left;
      font-weight: 600;
    }
    
    .csv-table td {
      padding: 8px;
      border: 1px solid rgba(255,255,255,.05);
    }
    
    .csv-table tr:nth-child(even) {
      background: rgba(255,255,255,.02);
    }
  
/* MOBILE_DASHBOARD_TWEAKS */
@media (max-width: 600px){
  .app{ width: 94vw; padding: 18px 0 40px; }
  .topbar{ flex-direction:column; align-items:flex-start; }
  .tabs{ gap:8px; }
  .tab-btn{ width:100%; justify-content:center; }
  .dashboard-stats-grid{ grid-template-columns: 1fr; }
  .org-grid{ grid-template-columns: 1fr; }
  .live-charts-container{ grid-template-columns: 1fr !important; }
  .row{ gap:10px; }
  .btn{ width:100%; }
  .btn + .btn{ margin-top:8px; }
}


  .ec-content{display:none;}
  .ec-content.active{display:block;}
</style>

<!-- NEON UI APPLIED (STYLE ONLY) -->
<style>

:root{
  --bg:#070b1a;
  --card:#0e1630;
  --neon1:#9D00FF;
  --neon2:#00E5FF;
  --accent:#00ffaa;
  --danger:#ff4d4d;
  --text:#ffffff;
  --muted:#9bb0ff;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Inter,system-ui,sans-serif;
  background:radial-gradient(circle at 20% 20%,#101a44,var(--bg));
  color:var(--text);
  padding:14px;
  min-height:100vh;
}
.container{max-width:1200px;margin:auto}
h2,h3{
  text-align:center;
  margin-bottom:14px;
  background:linear-gradient(90deg,var(--neon1),var(--neon2));
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
}
.card{
  background:linear-gradient(180deg,rgba(14,22,48,.95),rgba(8,12,28,.95));
  border-radius:18px;
  padding:18px;
  margin-bottom:18px;
  border:1px solid rgba(157,0,255,.25);
  box-shadow:0 0 25px rgba(157,0,255,.15);
}
input,button,select{
  width:100%;
  padding:14px;
  margin-top:10px;
  border-radius:14px;
  font-size:16px;
  border:none;
}
input,select{
  background:rgba(0,0,0,.4);
  color:var(--text);
  border:1px solid rgba(0,229,255,.25);
}
button{
  background:linear-gradient(135deg,var(--neon1),var(--neon2));
  color:#fff;
  font-weight:700;
  cursor:pointer;
}
button.danger{
  background:linear-gradient(135deg,#ff4d4d,#ff0000);
}
.tabs{
  display:flex;
  gap:10px;
  margin-bottom:20px;
}
.tabs button{
  flex:1;
  background:#111a3a;
}
.tabs button.active{
  background:linear-gradient(135deg,var(--neon1),var(--neon2));
}
.hidden{display:none}
.ballot label{
  display:flex;
  gap:12px;
  align-items:center;
  padding:12px;
  margin-top:8px;
  background:rgba(255,255,255,.05);
  border-radius:14px;
  border:1px solid rgba(0,229,255,.2);
}
.ballot input{width:auto;accent-color:var(--accent)}
.charts{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:16px;
  margin-top:12px;
}
canvas{
  width:100%!important;
  height:auto!important;
  background:rgba(0,0,0,.35);
  border-radius:14px;
  padding:10px;
  border:1px solid rgba(0,229,255,.2);
}
@media(max-width:768px){
  .charts{grid-template-columns:1fr}
  body{padding:10px}
}


/* MOBILE_DASHBOARD_TWEAKS */
@media (max-width: 600px){
  .app{ width: 94vw; padding: 18px 0 40px; }
  .topbar{ flex-direction:column; align-items:flex-start; }
  .tabs{ gap:8px; }
  .tab-btn{ width:100%; justify-content:center; }
  .dashboard-stats-grid{ grid-template-columns: 1fr; }
  .org-grid{ grid-template-columns: 1fr; }
  .live-charts-container{ grid-template-columns: 1fr !important; }
  .row{ gap:10px; }
  .btn{ width:100%; }
  .btn + .btn{ margin-top:8px; }
}

</style>
<!-- END NEON UI -->

</head>

<body>
  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay">
    <div style="text-align: center">
      <div class="spinner"></div>
      <div style="margin-top: 15px; color: var(--text)" id="loadingText">Initializing Firebase...</div>
    </div>
  </div>
  
  <div class="app">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"><i class="fas fa-check-to-slot"></i></div>
        <div>
          <h1>Neon Voting System</h1>
          <div class="subtitle">Super Admin • Election Commissioner • Voter • Public Results • Guest</div>
        </div>
      </div>
      <span class="badge primary">v4.2 • Real-time Sync</span>
    </div>

    <!-- =========================================================
         GATEWAY (MAIN)
         ========================================================= -->
    <section id="gatewayScreen" class="screen active">
      <div class="card">
        <div class="section-title">
          <div>
            <h2 style="margin:0;font-size:18px">Choose your role</h2>
            <div class="subtext">Select an interface to continue.</div>
          </div>
        </div>

        <div class="grid" style="margin-top:12px">
          <div class="col-6">
            <button id="btn-superadmin" class="btn btn-block neon-btn">
              <i class="fas fa-crown"></i> Super Admin
            </button>
            <div class="subtext" style="margin-top:8px">Create organizations, approve elections, manage global settings.</div>
          </div>
          <div class="col-6">
            <button id="btn-ec" class="btn btn-block neon-btn">
              <i class="fas fa-user-shield"></i> Election Commissioner
            </button>
            <div class="subtext" style="margin-top:8px">Setup election: voters, positions, candidates, schedule & submit for approval.</div>
          </div>
          <div class="col-6">
            <button id="btn-voter" class="btn btn-block neon-btn">
              <i class="fas fa-person-booth"></i> Voter
            </button>
            <div class="subtext" style="margin-top:8px">Login with your Voter ID + PIN and cast your ballot.</div>
          </div>
          <div class="col-6">
            <button id="btn-public" class="btn btn-block neon-btn-outline">
              <i class="fas fa-chart-column"></i> Public Results
            </button>
            <div class="subtext" style="margin-top:8px">View results (if enabled by the organization).</div>
          </div>
          <div class="col-12">
            <button id="btn-guest" class="btn btn-block neon-btn-outline">
              <i class="fas fa-eye"></i> Guest View
            </button>
            <div class="subtext" style="margin-top:8px">Explore the platform (limited view).</div>
          </div>
        </div>
        
        <!-- Firebase Status -->
        <div class="setup-instructions" style="margin-top: 20px;">
          <h4><i class="fas fa-database"></i> Firebase Configuration</h4>
          <div class="subtext">
            <strong>Project ID:</strong> neon-voting-system<br>
            <strong>API Key:</strong> AIzaSyCXxONjV0Vh2fVJ6Tk2yXqX8n8M8Y7q3ZQ<br>
            <strong>Auth Domain:</strong> neon-voting-system.firebaseapp.com<br>
            <strong>Storage Bucket:</strong> neon-voting-system.appspot.com<br>
            <strong>Messaging Sender ID:</strong> 123456789012<br>
            <strong>App ID:</strong> 1:123456789012:web:abcdef1234567890abcdef<br>
            <strong>Status:</strong> <span id="firebaseLiveStatus" class="badge success">Live Sync Active</span>
          </div>
        </div>
      </div>
    </section>

    <!-- =========================================================
         SUPER ADMIN LOGIN
         ========================================================= -->
    <section id="superAdminLoginScreen" class="screen">
      <div class="super-login-container">
        <div class="super-login-card">
          <div class="super-login-header">
            <div>
              <h2 class="super-login-title">
                <i class="fas fa-crown"></i> Super Admin Login
              </h2>
              <p class="super-login-sub">Owner access to manage organizations and approve elections</p>
            </div>
            <button class="super-login-back" onclick="showScreen('gatewayScreen')">
              <i class="fas fa-arrow-left"></i> Back
            </button>
          </div>

          <div class="super-login-body">
            <label class="super-login-label">Super Admin Password</label>
            <input 
              id="super-admin-pass" 
              type="password" 
              class="super-login-input" 
              placeholder="Enter super admin password"
              autocomplete="off"
            />

            <div id="super-admin-error" class="password-error">
              <i class="fas fa-exclamation-circle"></i>
              <span id="super-admin-error-text">Invalid password. Please try again.</span>
            </div>

            <button id="super-login-btn" class="super-login-btn" onclick="loginSuperAdmin()">
              <i class="fas fa-sign-in-alt"></i>
              Login
            </button>

            <div class="setup-instructions">
              <h4><i class="fas fa-database"></i> Firestore Setup</h4>
              <div class="subtext">
                <strong>Default Password:</strong> <code>admin123</code><br>
                <strong>Real-time Sync:</strong> <span class="badge success">Active</span><br>
                <small>All organization data syncs instantly with global dashboard.</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- =========================================================
         SUPER ADMIN PANEL
         ========================================================= -->
    <section id="superAdminPanel" class="screen">
      <div class="card">
        <div class="section-title">
          <div>
            <h2 style="margin:0;font-size:18px"><i class="fas fa-crown"></i> Super Admin</h2>
            <div class="subtext">Create organizations, approve elections, manage settings.</div>
          </div>
          <div class="row">
            <button class="btn neon-btn-outline logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</button>
            <button id="super-back" class="btn neon-btn-outline"><i class="fas fa-home"></i> Gateway</button>
          </div>
        </div>

        <!-- Updated tabs with Global Dashboard -->
        <div id="superTabs" class="tabs" role="tablist" aria-label="Super Admin Tabs">
          <button class="tab-btn active" data-super-tab="dashboard"><i class="fas fa-globe"></i> Global Dashboard</button>
          <button class="tab-btn" data-super-tab="orgs"><i class="fas fa-building"></i> Organizations</button>
          <button class="tab-btn" data-super-tab="approvals"><i class="fas fa-clipboard-check"></i> Approvals</button>
          <button class="tab-btn" data-super-tab="settings"><i class="fas fa-gear"></i> Settings</button>
          <button class="tab-btn" data-super-tab="danger"><i class="fas fa-triangle-exclamation"></i> Danger Zone</button>
        </div>

        <div style="margin-top:14px">
          <!-- Global Dashboard Tab (NEW) -->
          <div id="superContent-dashboard">
            <!-- Dashboard Header -->
            <div class="dashboard-header">
              <div>
                <h3 style="margin:0"><i class="fas fa-globe"></i> Live Global Dashboard</h3>
                <p class="subtext">Real-time overview of all organizations, elections, and voting activity</p>
              </div>
              <div class="refresh-controls">
                <div class="sync-indicator">
                  <div class="sync-pulse"></div>
                  <span>Live Sync Active</span>
                </div>
                <div class="time-filter">
                  <button class="time-filter-btn active" onclick="setDashboardTimeFilter('24h')">24h</button>
                  <button class="time-filter-btn" onclick="setDashboardTimeFilter('7d')">7d</button>
                  <button class="time-filter-btn" onclick="setDashboardTimeFilter('30d')">30d</button>
                  <button class="time-filter-btn" onclick="setDashboardTimeFilter('all')">All</button>
                </div>
                <button class="btn" style="padding: 8px 12px; font-size: 12px" onclick="refreshDashboard()">
                  <i class="fas fa-sync"></i> Refresh
                </button>

              <div class="export-actions" style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
                <button class="btn" onclick="exportResultsCSV(window.currentOrgId)"><i class="fas fa-file-csv"></i> Export Results (CSV)</button>
                <button class="btn" onclick="exportResultsPDF(window.currentOrgId)"><i class="fas fa-file-pdf"></i> Export Results (PDF)</button>
                <button class="btn secondary" onclick="exportAuditCSV(window.currentOrgId)"><i class="fas fa-clipboard-list"></i> Export Audit (CSV)</button>
              </div>
              </div>
            </div>

            <!-- Real-time Stats -->
            <div class="dashboard-stats-grid">
              <div class="dashboard-stat-card">
                <div class="dashboard-stat-label">Total Organizations</div>
                <div class="dashboard-stat-value" id="statOrganizations">0</div>
                <div class="dashboard-stat-change change-positive" id="statOrgsChange">Loading...</div>
              </div>
              <div class="dashboard-stat-card">
                <div class="dashboard-stat-label">Active Elections</div>
                <div class="dashboard-stat-value" id="statActiveElections">0</div>
                <div class="dashboard-stat-change change-positive" id="statElectionsChange">Live</div>
              </div>
              <div class="dashboard-stat-card">
                <div class="dashboard-stat-label">Total Votes Today</div>
                <div class="dashboard-stat-value" id="statVotesToday">0</div>
                <div class="dashboard-stat-change change-positive" id="statVotesChange">+0% from yesterday</div>
              </div>
              <div class="dashboard-stat-card">
                <div class="dashboard-stat-label">Total Voters</div>
                <div class="dashboard-stat-value" id="statTotalVoters">0</div>
                <div class="dashboard-stat-change change-positive" id="statVotersChange">+0 this week</div>
              </div>
              <div class="dashboard-stat-card">
                <div class="dashboard-stat-label">Avg. Turnout</div>
                <div class="dashboard-stat-value" id="statAvgTurnout">0%</div>
                <div class="dashboard-stat-change change-positive" id="statTurnoutChange">+0% trend</div>
              </div>
              <div class="dashboard-stat-card">
                <div class="dashboard-stat-label">Pending Approvals</div>
                <div class="dashboard-stat-value" id="statPendingApprovals">0</div>
                <div class="dashboard-stat-change change-negative" id="statApprovalsChange">Needs attention</div>
              </div>
            </div>

            <!-- Live Charts Container -->
            <div class="live-charts-container">
              <div class="chart-container">
                <div class="chart-title"><i class="fas fa-chart-line"></i> Votes Per Hour (Last 24 Hours)</div>
                <canvas id="votesChart"></canvas>
              </div>
              <div class="chart-container">
                <div class="chart-title"><i class="fas fa-chart-pie"></i> Election Status Distribution</div>
                <canvas id="electionsChart"></canvas>
              </div>
            </div>

            <!-- Recent Activity -->
            <div style="margin-top: 24px">
              <div class="section-title">
                <h3 style="margin:0"><i class="fas fa-history"></i> Recent Activity</h3>
                <button class="btn" style="padding: 6px 12px; font-size: 11px" onclick="loadActivityFeed()">
                  <i class="fas fa-redo"></i> Load More
                </button>
              </div>
              <div class="activity-timeline" id="activityFeed">
                <!-- Activity items will be loaded here -->
              </div>
            </div>

            <!-- Organizations Overview -->
            <div style="margin-top: 24px">
              <div class="section-title">
                <h3 style="margin:0"><i class="fas fa-building"></i> Organizations Overview</h3>
                <button class="btn neon-btn" style="padding: 8px 12px; font-size: 12px" onclick="showAllOrganizations()">
                  <i class="fas fa-list"></i> View All
                </button>
              </div>
              <div class="org-grid" id="orgOverviewGrid">
                <!-- Organization cards will be loaded here -->
              </div>
            </div>

            <!-- Live Data Sync Status -->
            <div class="data-management" style="margin-top: 24px">
              <div class="data-management-header">
                <h4 style="margin:0"><i class="fas fa-sync"></i> Live Data Sync Status</h4>
                <span class="badge success">Connected</span>
              </div>
              <div class="subtext" style="margin-bottom: 12px">
                Real-time synchronization between EC interfaces and global dashboard. 
                Data updates instantly when ECs make changes.
              </div>
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Data Type</th>
                    <th>Last Sync</th>
                    <th>Status</th>
                    <th>Records</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>Organizations</td>
                    <td id="syncOrgsTime">Just now</td>
                    <td><span class="badge success">Active</span></td>
                    <td id="syncOrgsCount">0</td>
                  </tr>
                  <tr>
                    <td>Voters</td>
                    <td id="syncVotersTime">Just now</td>
                    <td><span class="badge success">Active</span></td>
                    <td id="syncVotersCount">0</td>
                  </tr>
                  <tr>
                    <td>Positions</td>
                    <td id="syncPositionsTime">Just now</td>
                    <td><span class="badge success">Active</span></td>
                    <td id="syncPositionsCount">0</td>
                  </tr>
                  <tr>
                    <td>Candidates</td>
                    <td id="syncCandidatesTime">Just now</td>
                    <td><span class="badge success">Active</span></td>
                    <td id="syncCandidatesCount">0</td>
                  </tr>
                  <tr>
                    <td>Votes</td>
                    <td id="syncVotesTime">Just now</td>
                    <td><span class="badge success">Active</span></td>
                    <td id="syncVotesCount">0</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Organizations Tab -->
          <div id="superContent-orgs" style="display:none">
            <div class="row" style="justify-content:space-between; margin-bottom:12px">
              <div class="subtext">Manage organizations and their elections.</div>
              <button class="btn neon-btn" onclick="showCreateOrgModal()"><i class="fas fa-plus"></i> Create Organization</button>
            </div>
            <div id="super-org-list" style="margin-top:10px"></div>
          </div>

          <!-- Approvals Tab -->
          <div id="superContent-approvals" style="display:none">
            <h3 style="margin:0 0 12px"><i class="fas fa-clipboard-check"></i> Pending Approvals</h3>
            <div class="subtext" style="margin-bottom:12px">Review and approve/reject election submissions from ECs.</div>
            <div id="superApprovalList"></div>
          </div>

          <!-- Settings Tab -->
          <div id="superContent-settings" style="display:none">
            <div class="grid">
              <div class="col-6">
                <div class="card" style="padding:14px">
                  <h3 style="margin:0 0 8px">Change SuperAdmin Password</h3>
                  <div class="subtext">Minimum 8 characters.</div>
                  <label class="label">New Password</label>
                  <input id="new-super-pass" class="input" type="password" placeholder="New password"/>
                  <button class="btn neon-btn" style="margin-top:12px" onclick="changeSuperPassword()">
                    <i class="fas fa-key"></i> Update Password
                  </button>
                </div>
              </div>
              <div class="col-6">
                <div class="card" style="padding:14px">
                  <h3 style="margin:0 0 8px">Firebase Status</h3>
                  <div class="subtext">Current Firebase connection status.</div>
                  <div id="firebaseStatusDisplay" style="margin:10px 0">
                    <div class="badge info">Checking...</div>
                  </div>
                  <button class="btn neon-btn-outline" style="margin-top:12px" onclick="checkFirebaseStatus()">
                    <i class="fas fa-sync"></i> Refresh Status
                  </button>
                </div>
              </div>
              <div class="col-12">
                <div class="card" style="padding:14px; margin-top:14px">
                  <h3 style="margin:0 0 8px">Data Sync Configuration</h3>
                  <div class="subtext">Configure real-time data synchronization settings.</div>
                  
                  <div style="margin-top:12px">
                    <label style="display:flex; align-items:center; gap:8px; margin-bottom:8px">
                      <input type="checkbox" id="enableRealtimeSync" checked>
                      <span>Enable real-time data sync</span>
                    </label>
                    <label style="display:flex; align-items:center; gap:8px; margin-bottom:8px">
                      <input type="checkbox" id="enableAutoRefresh" checked>
                      <span>Auto-refresh dashboard every 30 seconds</span>
                    </label>
                    <label style="display:flex; align-items:center; gap:8px; margin-bottom:8px">
                      <input type="checkbox" id="enableActivityLogging" checked>
                      <span>Log all EC activity to dashboard</span>
                    </label>
                    
                    <button class="btn neon-btn" style="margin-top:12px" onclick="saveSyncSettings()">
                      <i class="fas fa-save"></i> Save Sync Settings
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Danger Zone Tab -->
          <div id="superContent-danger" style="display:none">
            <div class="card" style="padding:14px; border-color: rgba(255,75,75,.30)">
              <h3 style="margin:0 0 8px; color:#ffb3b3"><i class="fas fa-triangle-exclamation"></i> Danger Zone</h3>
              <div class="subtext">Use carefully.</div>
              <button class="btn" style="margin-top:12px; border-color: rgba(255,75,75,.35)" onclick="resetAppData()">
                <i class="fas fa-bomb"></i> Reset App Data
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- =========================================================
         EC LOGIN
         ========================================================= -->
    <section id="ecLoginScreen" class="screen">
      <div class="card">
        <div class="section-title">
          <div>
            <h2 style="margin:0;font-size:18px"><i class="fas fa-user-shield"></i> EC Login</h2>
            <div class="subtext">Enter Organization ID and EC password.</div>
          </div>
          <button id="ec-back" class="btn neon-btn-outline"><i class="fas fa-arrow-left"></i> Back</button>
        </div>

        <label class="label">Organization ID</label>
        <input id="ec-org-id" class="input" placeholder="e.g. ORG-123"/>

        <label class="label">EC Password</label>
        <input id="ec-pass" class="input" type="password" placeholder="Enter EC password"/>

        <button id="ec-login-btn" class="btn btn-block neon-btn" style="margin-top:12px">
          <i class="fas fa-right-to-bracket"></i> Login
        </button>
      </div>
    </section>

    <!-- =========================================================
         EC PANEL (SYNCED WITH GLOBAL DASHBOARD)
         ========================================================= -->
    <section id="ecPanel" class="screen">
      <div class="card">
        <div class="section-title">
          <div>
            <h2 style="margin:0;font-size:18px"><i class="fas fa-user-shield"></i> EC Dashboard</h2>
            <div class="subtext">
              <span id="ecOrgName">Organization</span>
              <span style="opacity:.5">•</span>
              ID: <span id="ecOrgIdDisplay">—</span>
              <span style="opacity:.5">•</span>
              Status: <span id="ecElectionStatus" class="badge">Not Started</span>
              <span style="opacity:.5">•</span>
              <span class="sync-indicator">
                <div class="sync-pulse"></div>
                <span>Syncing to Global Dashboard</span>
              </span>
            </div>
          </div>
          <div class="row">
            <button class="btn neon-btn-outline logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</button>
            <button id="ec-back" class="btn neon-btn-outline"><i class="fas fa-home"></i> Gateway</button>
          </div>
        </div>

        <!-- EC Panel Tabs with Bulk Invite placed correctly -->
        <div id="electionCountdownBanner" class="countdown-banner" style="display:none;margin:10px 0;padding:10px 12px;border:1px solid rgba(0,255,255,.2);border-radius:12px;background:rgba(0,255,255,.06);color:#eaf2ff;font-weight:600"></div>
        <div id="ecTabs" class="tabs" role="tablist" aria-label="EC Tabs">
          <button class="tab-btn active" data-ec-tab="voters">
            <i class="fas fa-users"></i> Voters
          </button>
          <button class="tab-btn" data-ec-tab="bulk-invite">
            <i class="fas fa-mail-bulk"></i> Bulk Invite
          </button>
          <button class="tab-btn" data-ec-tab="positions">
            <i class="fas fa-list-ol"></i> Positions
          </button>
          <button class="tab-btn" data-ec-tab="candidates">
            <i class="fas fa-user-friends"></i> Candidates
          </button>
          <button class="tab-btn" data-ec-tab="outcomes">
            <i class="fas fa-chart-bar"></i> Outcomes
          </button>
          <button class="tab-btn" data-ec-tab="settings">
            <i class="fas fa-cog"></i> Settings
          </button>
          <button class="tab-btn" data-ec-tab="approval">
            <i class="fas fa-clipboard-check"></i> Approval
          </button>
        </div>

        <div style="margin-top:14px">
          <!-- Voters Tab -->
          <div id="ecContent-voters" class="ec-content" style="display: block;">
            <div class="row" style="justify-content:space-between">
              <div class="subtext">Add and manage voters. Changes sync to global dashboard instantly.</div>
              <div class="row">
                <button class="btn neon-btn-outline" onclick="switchToBulkInvite()">
                  <i class="fas fa-mail-bulk"></i> Bulk Invite
                </button>
                <button class="btn neon-btn" onclick="showAddVoterModal()">
                  <i class="fas fa-user-plus"></i> Add Voter
                </button>
              </div>
            </div>
            
            <!-- Voter Stats (Synced to Dashboard) -->
            <div class="outcome-stats" style="margin: 12px 0">
              <div class="stat-card">
                <div class="stat-value" id="ecVoterCount">0</div>
                <div class="stat-label">Total Voters</div>
              </div>
              <div class="stat-card">
                <div class="stat-value" id="ecVotedCount">0</div>
                <div class="stat-label">Voted</div>
              </div>
              <div class="stat-card">
                <div class="stat-value" id="ecTurnoutPercent">0%</div>
                <div class="stat-label">Turnout</div>
              </div>
              <div class="stat-card">
                <div class="stat-value" id="ecInvitedCount">0</div>
                <div class="stat-label">Invited</div>
              </div>
            </div>
            
            <div id="ecVoterList" style="margin-top:12px"></div>
          </div>

          <!-- Bulk Invite Tab -->
          <div id="ecContent-bulk-invite" class="ec-content" style="display:none">
            <div class="bulk-invite-header">
              <div>
                <h3 style="margin:0"><i class="fas fa-mail-bulk"></i> Bulk Voter Invite</h3>
                <p class="subtext">Invite multiple voters at once using CSV, Excel, or manual entry</p>
              </div>
              <button class="btn neon-btn-outline" onclick="showInviteHistory()">
                <i class="fas fa-history"></i> Invite History
              </button>
            </div>

            <div class="bulk-invite-tabs">
              <button class="bulk-invite-tab active" onclick="showBulkTab('manual')">
                <i class="fas fa-keyboard"></i> Manual Entry
              </button>
              <button class="bulk-invite-tab" onclick="showBulkTab('csv')">
                <i class="fas fa-file-csv"></i> CSV Upload
              </button>
              <button class="bulk-invite-tab" onclick="showBulkTab('excel')">
                <i class="fas fa-file-excel"></i> Excel Upload
              </button>
              <button class="bulk-invite-tab" onclick="showBulkTab('template')">
                <i class="fas fa-layer-group"></i> Templates
              </button>
            </div>

            <!-- Manual Entry Tab -->
            <div id="bulkTab-manual" class="bulk-invite-container">
              <div class="card" style="margin-bottom: 16px; padding: 16px">
                <h4 style="margin:0 0 12px 0"><i class="fas fa-keyboard"></i> Enter Voter Details</h4>
                <p class="subtext" style="margin-bottom: 16px">
                  Enter one voter per line in format: <code>Email/Phone, Full Name, PIN (optional)</code><br>
                  Example: <code>john@example.com, John Doe, 1234</code>
                </p>
                
                <textarea id="bulkVoterText" class="bulk-textarea" placeholder="john@example.com, John Doe, 1234
jane@example.com, Jane Smith, 5678
+1234567890, Bob Johnson, 9012"></textarea>
                
                <div class="bulk-preview" id="manualPreview">
                  <div style="text-align: center; padding: 20px">
                    <div class="spinner" style="width: 24px; height: 24px; margin: 0 auto 10px"></div>
                    <div class="subtext">Preview will appear here</div>
                  </div>
                </div>
                
                <div class="bulk-actions">
                  <button class="btn neon-btn-outline" onclick="previewBulkVoters()">
                    <i class="fas fa-eye"></i> Preview
                  </button>
                  <button class="btn neon-btn" onclick="sendBulkInvites()" id="sendBulkBtn">
                    <i class="fas fa-paper-plane"></i> Send Invites
                  </button>
                </div>
              </div>
            </div>

            <!-- CSV Upload Tab -->
            <div id="bulkTab-csv" class="bulk-invite-container" style="display:none">
              <div class="card" style="margin-bottom: 16px; padding: 16px">
                <h4 style="margin:0 0 12px 0"><i class="fas fa-file-csv"></i> Upload CSV File</h4>
                <p class="subtext" style="margin-bottom: 16px">
                  Upload a CSV file with columns: <code>email/phone, name, pin</code><br>
                  First row should be headers. Maximum file size: 5MB
                </p>
                
                <div class="upload-area" id="csvUploadArea" onclick="document.getElementById('csvFileInput').click()">
                  <div class="upload-icon">
                    <i class="fas fa-cloud-upload-alt"></i>
                  </div>
                  <div class="upload-text">Click to upload CSV file</div>
                  <div class="upload-subtext">or drag and drop file here</div>
                </div>
                
                <input type="file" id="csvFileInput" class="file-input" accept=".csv" onchange="handleCSVUpload(this)">
                
                <div id="csvPreview" class="csv-preview" style="display:none">
                  <!-- CSV preview will be inserted here -->
                </div>
                
                <div class="bulk-actions" style="margin-top: 20px">
                  <button class="btn neon-btn" onclick="processCSVFile()" id="processCSVBtn" disabled>
                    <i class="fas fa-check"></i> Process CSV
                  </button>
                </div>
              </div>
            </div>

            <!-- Excel Upload Tab -->
            <div id="bulkTab-excel" class="bulk-invite-container" style="display:none">
              <div class="card" style="margin-bottom: 16px; padding: 16px">
                <h4 style="margin:0 0 12px 0"><i class="fas fa-file-excel"></i> Upload Excel File</h4>
                <p class="subtext" style="margin-bottom: 16px">
                  Upload an Excel file (XLSX) with columns: <code>email/phone, name, pin</code><br>
                  First row should be headers. Maximum file size: 10MB
                </p>
                
                <div class="upload-area" id="excelUploadArea" onclick="document.getElementById('excelFileInput').click()">
                  <div class="upload-icon">
                    <i class="fas fa-file-excel"></i>
                  </div>
                  <div class="upload-text">Click to upload Excel file</div>
                  <div class="upload-subtext">.xlsx files only</div>
                </div>
                
                <input type="file" id="excelFileInput" class="file-input" accept=".xlsx,.xls" onchange="handleExcelUpload(this)">
                
                <div class="bulk-actions" style="margin-top: 20px">
                  <button class="btn neon-btn" onclick="processExcelFile()" id="processExcelBtn" disabled>
                    <i class="fas fa-check"></i> Process Excel
                  </button>
                </div>
              </div>
            </div>

            <!-- Templates Tab -->
            <div id="bulkTab-template" class="bulk-invite-container" style="display:none">
              <div class="card" style="margin-bottom: 16px; padding: 16px">
                <h4 style="margin:0 0 12px 0"><i class="fas fa-layer-group"></i> Invite Templates</h4>
                <p class="subtext" style="margin-bottom: 16px">
                  Use pre-built templates for different types of elections
                </p>
                
                <div class="template-container">
                  <div class="template-card" onclick="selectTemplate('university')">
                    <div class="template-name">University Election</div>
                    <div class="template-description">Template for student council elections with student emails</div>
                    <div class="template-stats">
                      <span><i class="fas fa-users"></i> Student format</span>
                      <span><i class="fas fa-envelope"></i> Email invites</span>
                    </div>
                  </div>
                  
                  <div class="template-card" onclick="selectTemplate('corporate')">
                    <div class="template-name">Corporate Board Election</div>
                    <div class="template-description">Template for corporate board elections with employee emails</div>
                    <div class="template-stats">
                      <span><i class="fas fa-building"></i> Employee format</span>
                      <span><i class="fas fa-id-badge"></i> Department info</span>
                    </div>
                  </div>
                  
                  <div class="template-card" onclick="selectTemplate('community')">
                    <div class="template-name">Community Election</div>
                    <div class="template-description">Template for community associations with phone numbers</div>
                    <div class="template-stats">
                      <span><i class="fas fa-phone"></i> Phone invites</span>
                      <span><i class="fas fa-home"></i> Address info</span>
                    </div>
                  </div>
                </div>
                
                <div class="bulk-actions" style="margin-top: 20px">
                  <button class="btn neon-btn" onclick="useSelectedTemplate()" id="useTemplateBtn" disabled>
                    <i class="fas fa-check"></i> Use Template
                  </button>
                </div>
              </div>
            </div>

            <!-- Progress Bar -->
            <div class="bulk-progress" id="bulkProgress" style="display:none">
              <div class="section-title">
                <h4 style="margin:0"><i class="fas fa-sync"></i> Sending Invites</h4>
                <span class="badge info" id="progressStatus">Processing...</span>
              </div>
              
              <div class="bulk-progress-bar">
                <div class="bulk-progress-fill" id="progressFill" style="width: 0%"></div>
              </div>
              
              <div class="bulk-progress-text">
                <span id="progressCurrent">0</span>
                <span id="progressTotal">0</span>
              </div>
              
              <div class="bulk-actions" style="margin-top: 20px">
                <button class="btn neon-btn-outline" onclick="cancelBulkInvite()">
                  <i class="fas fa-times"></i> Cancel
                </button>
              </div>
            </div>
          </div>

          <!-- Positions Tab -->
          <div id="ecContent-positions" class="ec-content" style="display:none">
            <div class="row" style="justify-content:space-between">
              <div class="subtext">Create positions (single/multiple choice). Synced to dashboard.</div>
              <button class="btn neon-btn" onclick="showAddPositionModal()"><i class="fas fa-plus-circle"></i> Add Position</button>
            </div>
            <div id="ecPositionList" style="margin-top:12px"></div>
          </div>

          <!-- Candidates Tab -->
          <div id="ecContent-candidates" class="ec-content" style="display:none">
            <div class="row" style="justify-content:space-between">
              <div class="subtext">Add candidates to positions. Synced to dashboard.</div>
              <button class="btn neon-btn" onclick="showAddCandidateModal()"><i class="fas fa-user-plus"></i> Add Candidate</button>
            </div>
            <div id="ecCandidateList" style="margin-top:12px"></div>
          </div>

          <!-- Outcomes Tab -->
          <div id="ecContent-outcomes" class="ec-content" style="display:none">
            <div class="card" style="padding: 14px">
              <div class="section-title">
                <div>
                  <h3 style="margin:0 0 8px"><i class="fas fa-chart-bar"></i> Real-time Election Outcomes</h3>
                  <div class="subtext" style="margin-bottom:12px">Live results synchronized with global dashboard</div>
                </div>
                <div class="real-time-indicator">
                  <div class="pulse-dot"></div>
                  <span style="font-size:11px">Live Updates</span>
                </div>
              </div>
              
              <!-- Election Statistics -->
              <div class="outcome-stats">
                <div class="stat-card">
                  <div class="stat-value" id="totalVotes">0</div>
                  <div class="stat-label">Total Votes</div>
                </div>
                <div class="stat-card">
                  <div class="stat-value" id="voterTurnout">0%</div>
                  <div class="stat-label">Voter Turnout</div>
                </div>
                <div class="stat-card">
                  <div class="stat-value" id="positionsCount">0</div>
                  <div class="stat-label">Positions</div>
                </div>
                <div class="stat-card">
                  <div class="stat-value" id="candidatesCount">0</div>
                  <div class="stat-label">Candidates</div>
                </div>
              </div>
              
              
              <!-- Export Actions -->
              <div class="export-actions" style="margin:12px 0; display:flex; gap:10px; flex-wrap:wrap;">
                <button class="btn neon-btn-outline" onclick="exportResultsCSV(window.currentOrgId)"><i class="fas fa-file-csv"></i> Export Results (CSV)</button>
                <button class="btn neon-btn-outline" onclick="exportResultsPDF(window.currentOrgId)"><i class="fas fa-file-pdf"></i> Export Results (PDF)</button>
              </div>
<!-- Position-wise Results -->
              <div id="ecOutcomeResults" style="margin-top: 20px;">
                <div style="text-align: center; padding: 40px 20px;">
                  <div class="spinner" style="width: 30px; height: 30px; margin: 0 auto 15px;"></div>
                  <div class="subtext">Loading real-time election outcomes...</div>
                  <div class="subtext" style="margin-top: 8px; font-size: 10px;">Syncing with global dashboard</div>
                </div>
              </div>
              
              <!-- Last Update Time -->
              <div class="subtext" style="text-align: center; margin-top: 16px; font-size: 10px;">
                <i class="fas fa-sync"></i> Last updated: <span id="lastUpdateTime">Just now</span>
              </div>
            </div>
          </div>

          <!-- Settings Tab -->
          <div id="ecContent-settings" class="ec-content" style="display:none">
            <div class="card" style="margin-bottom: 14px; padding: 14px">
              <h3 style="margin: 0 0 8px">Election Settings</h3>
              
              <div class="form-grid">
                <div class="form-group">
                  <label for="electionTitle">Election Title</label>
                  <input id="electionTitle" class="input" placeholder="e.g. 2025 Board Elections">
                </div>
                
                <div class="form-group">
                  <label for="electionStart">Start Date & Time</label>
                  <input id="electionStart" class="input" type="datetime-local">
                </div>
                
                <div class="form-group">
                  <label for="electionEnd">End Date & Time</label>
                  <input id="electionEnd" class="input" type="datetime-local">
                </div>
                
                <div class="form-group">
                  <label>
                    <input type="checkbox" id="resultsPublic"> Make results public after election
                  </label>
                </div>
                
                <div class="form-group">
                  <label>
                    <input type="checkbox" id="realTimeSync" checked> Sync to global dashboard in real-time
                  </label>
                  <div class="subtext" style="margin-top: 4px;">When enabled, all changes update Super Admin dashboard instantly</div>
                </div>
                
                <button class="btn neon-btn" onclick="saveElectionSettings()">
                  <i class="fas fa-save"></i> Save Settings
                </button>
              </div>
            </div>
          </div>

          <!-- Approval Tab -->
          <div id="ecContent-approval" class="ec-content" style="display:none">
            <div class="card" style="padding: 14px">
              <div class="section-title">
                <div>
                  <h3 style="margin: 0 0 4px"><i class="fas fa-clipboard-check"></i> Approval Status</h3>
                  <div class="subtext">Track your election's approval progress with Super Admin</div>
                </div>
                <span class="badge" id="approvalBadge">Not Submitted</span>
              </div>
              
              <div id="approvalDetails" style="margin-top: 12px">
                <div class="review-item">
                  <span class="k">Current Status:</span>
                  <span class="v" id="currentApprovalStatus">Not Submitted</span>
                </div>
                <div class="review-item">
                  <span class="k">Submitted Date:</span>
                  <span class="v" id="submittedDate">—</span>
                </div>
                <div class="review-item">
                  <span class="k">Reviewed By:</span>
                  <span class="v" id="reviewedBy">—</span>
                </div>
                <div class="review-item">
                  <span class="k">Comments:</span>
                  <span class="v" id="approvalComments">—</span>
                </div>
              </div>
              
              <div style="margin-top: 16px">
                <h4 style="margin: 0 0 8px">Submit for Approval</h4>
                <p class="subtext">Complete all requirements below before submission:</p>
                
                <ul id="approvalRequirements" class="checklist" style="margin: 12px 0">
                  <li id="reqVoters">❌ At least 1 voter added</li>
                  <li id="reqPositions">❌ At least 1 position created</li>
                  <li id="reqCandidates">❌ All positions have candidates</li>
                  <li id="reqSchedule">❌ Election schedule is set</li>
                </ul>
                
                <button id="finalSubmitBtn" class="btn neon-btn btn-block" disabled onclick="submitForApprovalFinal()">
                  <i class="fas fa-paper-plane"></i> Submit to Super Admin
                </button>
                
                <div id="approvalMessage" class="subtext" style="margin-top: 8px"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- =========================================================
         VOTER LOGIN
         ========================================================= -->
    <section id="voterLoginScreen" class="screen">
      <div class="card">
        <div class="section-title">
          <div>
            <h2 style="margin:0;font-size:18px"><i class="fas fa-person-booth"></i> Voter</h2>
            <div class="subtext">Login and vote. Votes sync instantly with global dashboard.</div>
          </div>
          <button id="voter-back" class="btn neon-btn-outline"><i class="fas fa-arrow-left"></i> Back</button>
        </div>

        <div class="screen-content">
          <div class="form-grid">
            <div class="form-group">
              <label for="voterOrgIdInput">Organization ID</label>
              <input id="voterOrgIdInput" type="text" placeholder="e.g. AMCAG-2025" autocomplete="off" />
            </div>

            <div class="form-group">
              <label for="voterCredentialInput">Email or Telephone Number</label>
              <input id="voterCredentialInput" type="text" placeholder="email@example.com or +233..." autocomplete="off" />
            </div>

            <button id="voterLoginBtn" class="btn btn-block neon-btn" type="button">
              <i class="fas fa-right-to-bracket"></i> Continue
            </button>

            <div id="voterLoginError" class="error-text"></div>

            <div class="subtext">
              <i class="fas fa-sync" style="color: var(--accent);"></i> Votes sync instantly with global dashboard.
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- =========================================================
         VOTING SCREEN (SYNCED WITH GLOBAL DASHBOARD)
         ========================================================= -->
    <section id="votingScreen" class="screen">
      <div class="card">
        <div class="section-title">
          <div>
            <h2 style="margin:0;font-size:18px"><i class="fas fa-check-to-slot"></i> Cast Your Vote</h2>
            <div class="subtext" id="votingOrgName">Organization</div>
          </div>
          <div class="row">
            <button id="voter-back" class="btn neon-btn-outline"><i class="fas fa-arrow-left"></i> Back</button>
            <button class="btn neon-btn-outline logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</button>
          </div>
        </div>

        <div id="votingCountdown" class="subtext" style="margin:8px 0 14px">
          <i class="fas fa-sync" style="color: var(--accent); margin-right: 6px;"></i>
          <span>Your vote will sync instantly with global dashboard</span>
        </div>

        <!-- Voting Interface -->
        <div id="ballotContainer"></div>

        <div style="margin-top:14px">
          <button class="btn btn-block neon-btn" onclick="submitVote()">
            <i class="fas fa-paper-plane"></i> Submit Vote
          </button>
          <div class="subtext" style="margin-top:8px">
            <i class="fas fa-info-circle" style="margin-right: 6px;"></i>
            Your vote syncs instantly with the global dashboard.
          </div>
        </div>
      </div>
    </section>

    <!-- =========================================================
         ALREADY VOTED SCREEN
         ========================================================= -->
    <section id="alreadyVotedScreen" class="screen">
      <div class="card" style="text-align:center">
        <div style="font-size:52px; color: var(--accent); margin-top:4px">
          <i class="fas fa-circle-check"></i>
        </div>
        <h2 style="margin:10px 0 6px">You already voted</h2>
        <div class="subtext" id="alreadyVotedMsg">This voter has already cast a ballot.</div>
        
        <div class="card" style="margin: 20px 0; padding: 16px; background: rgba(0,195,255,.05); border-color: rgba(0,195,255,.2)">
          <h4 style="margin:0 0 8px; color: var(--secondary)"><i class="fas fa-chart-bar"></i> Your Vote is Counted</h4>
          <div class="subtext">Your vote is included in the global dashboard.</div>
        </div>

        <div class="row" style="justify-content:center; margin-top:14px">
          <button class="btn neon-btn" onclick="showScreen('voterLoginScreen')">
            <i class="fas fa-right-to-bracket"></i> Back to Login
          </button>
          <button class="btn neon-btn-outline" onclick="showScreen('gatewayScreen')">
            <i class="fas fa-home"></i> Gateway
          </button>
        </div>
      </div>
    </section>

    <!-- =========================================================
         PUBLIC RESULTS (SYNCED)
         ========================================================= -->
    <section id="publicScreen" class="screen">
      <div class="card">
        <div class="section-title">
          <div>
            <h2 style="margin:0;font-size:18px"><i class="fas fa-chart-column"></i> Public Results</h2>
            <div class="subtext">View results using an organization public token (if enabled).</div>
          </div>
          <button id="public-back" class="btn neon-btn-outline"><i class="fas fa-arrow-left"></i> Back</button>
        </div>

        <div id="publicResultsBox" class="subtext">
          <div class="real-time-indicator" style="margin-bottom: 16px;">
            <div class="pulse-dot"></div>
            <span>Connected to live results feed</span>
          </div>
          Public results UI will load here (from script.js).
        </div>
      </div>
    </section>

    <!-- =========================================================
         GUEST
         ========================================================= -->
    <section id="guestScreen" class="screen">
      <div class="card">
        <div class="section-title">
          <div>
            <h2 style="margin:0;font-size:18px"><i class="fas fa-eye"></i> Guest View</h2>
            <div class="subtext">Limited exploration.</div>
          </div>
          <button id="guest-back" class="btn neon-btn-outline"><i class="fas fa-arrow-left"></i> Back</button>
        </div>

        <div class="subtext">
          This is a preview of the Neon Voting System. Please use the role buttons on the gateway to continue.
        </div>
      </div>
    </section>
  </div>

  <!-- MODALS -->
  <div id="modalOverlay" class="modal-overlay">
    <div id="modalContent" class="modal-content"></div>
  </div>

  <!-- Invite History Modal -->
  <div id="inviteHistoryModal" class="modal-overlay">
    <div class="modal-content">
      <div class="section-title">
        <h3 style="margin:0"><i class="fas fa-history"></i> Invite History</h3>
        <button class="btn" onclick="closeInviteHistory()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="invite-history">
        <table class="history-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Method</th>
              <th>Voters</th>
              <th>Status</th>
              <th>Details</th>
            </tr>
          </thead>
          <tbody id="inviteHistoryTable">
            <!-- History rows will be inserted here -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Toasts -->
  <div id="toastContainer"></div>

  <!-- Inline script for immediate functionality -->
  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCXxONjV0Vh2fVJ6Tk2yXqX8n8M8Y7q3ZQ",
      authDomain: "neon-voting-system.firebaseapp.com",
      projectId: "neon-voting-system",
      storageBucket: "neon-voting-system.appspot.com",
      messagingSenderId: "123456789012",
      appId: "1:123456789012:web:abcdef1234567890abcdef"
    };

    // Initialize Firebase
    let firebaseApp, firestore, auth;
    
    // Global state for data synchronization
    window.votingState = {
      currentOrgId: null,
      currentOrgName: null,
      realTimeSync: true,
      autoRefresh: true,
      activityLogging: true,
      dashboardTimeFilter: '24h',
      lastSyncTimes: {},
      firestoreListeners: [],
      syncStatus: {
        organizations: { count: 0, lastSync: null },
        voters: { count: 0, lastSync: null },
        positions: { count: 0, lastSync: null },
        candidates: { count: 0, lastSync: null },
        votes: { count: 0, lastSync: null }
      },
      bulkInvite: {
        currentVoters: [],
        processing: false,
        progress: 0,
        total: 0
      }
    };
    
    // Global charts instances
    let votesChart = null;
    let electionsChart = null;
    
    // Firebase collections
    const COLLECTIONS = {
      ORGANIZATIONS: 'organizations',
      VOTERS: 'voters',
      POSITIONS: 'positions',
      CANDIDATES: 'candidates',
      VOTES: 'votes',
      ELECTIONS: 'elections',
      SYSTEM_LOGS: 'systemLogs',
      APPROVALS: 'approvals',
      SYSTEM_CONFIG: 'systemConfig',
      INVITES: 'invites'
    };
    
    function initializeFirebase() {
      try {
        firebaseApp = firebase.initializeApp(firebaseConfig);
        firestore = firebase.firestore();
        auth = firebase.auth();
        console.log("Firebase initialized successfully");
        showToast("Firebase connected successfully - Real-time sync active", "success");
        document.getElementById('loadingOverlay').classList.remove('active');
        document.getElementById('firebaseLiveStatus').textContent = "Live Sync Active";
        
        // Initialize sync settings from localStorage
        loadSyncSettings();
        
        // Setup drag and drop for bulk invite
        setupDragAndDrop();
        
        return true;
      } catch (error) {
        console.error("Firebase initialization error:", error);
        showToast("Firebase initialization failed: " + error.message, "error");
        document.getElementById('loadingOverlay').classList.remove('active');
        return false;
      }
    }
    
    // Show loading overlay
    document.getElementById('loadingOverlay').classList.add('active');
    
    // Initialize Firebase when page loads
    window.addEventListener('DOMContentLoaded', function() {
      setTimeout(() => {
        initializeFirebase();
      }, 500);
    });

    // Basic screen switching
    function showScreen(screenId) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      const screen = document.getElementById(screenId);
      if (screen) {
        screen.classList.add('active');
      }
    }

    // Toast function
    function showToast(message, type = 'info') {
      const toastContainer = document.getElementById('toastContainer');
      if (!toastContainer) return;
      
      const toast = document.createElement('div');
      toast.className = 'card';
      toast.style.padding = '12px 16px';
      toast.style.border = '1px solid rgba(255,255,255,.12)';
      toast.style.borderRadius = '12px';
      toast.style.backgroundColor = 'var(--card)';
      toast.style.boxShadow = '0 10px 30px rgba(0,0,0,.3)';
      toast.style.maxWidth = '300px';
      toast.style.animation = 'fadeIn 0.25s ease';
      
      // Set color based on type
      let color = 'var(--text)';
      let icon = 'fas fa-info-circle';
      
      if (type === 'success') {
        color = 'var(--accent)';
        icon = 'fas fa-check-circle';
      } else if (type === 'error') {
        color = 'var(--danger)';
        icon = 'fas fa-exclamation-circle';
      } else if (type === 'warning') {
        color = '#ffc832';
        icon = 'fas fa-exclamation-triangle';
      }
      
      toast.innerHTML = `
        <div style="display: flex; align-items: center; gap: 10px;">
          <i class="${icon}" style="color: ${color}; font-size: 16px;"></i>
          <span style="font-size: 13px; line-height: 1.4;">${message}</span>
        </div>
      `;
      
      toastContainer.appendChild(toast);
      
      // Remove toast after 5 seconds
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateY(10px)';
        toast.style.transition = 'opacity 0.3s, transform 0.3s';
        
        setTimeout(() => {
          if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
          }
        }, 300);
      }, 5000);
    }

    // Super Admin Login with Firebase
    async function loginSuperAdmin() {
      const password = document.getElementById('super-admin-pass').value;
      const errorDiv = document.getElementById('super-admin-error');
      const errorText = document.getElementById('super-admin-error-text');
      
      if (!password) {
        errorText.textContent = "Please enter a password";
        errorDiv.classList.add('show');
        return;
      }
      
      // Show loading
      document.getElementById('loadingOverlay').classList.add('active');
      document.getElementById('loadingText').textContent = "Verifying credentials...";
      
      try {
        // Check if Firebase is initialized
        if (!firestore) {
          throw new Error("Firebase not initialized");
        }
        
        // Try to get super admin document from Firestore
        const docRef = firestore.collection("systemConfig").doc("superAdmin");
        const doc = await docRef.get();
        
        if (doc.exists) {
          const data = doc.data();
          const storedPassword = data.password;
          
          if (password === storedPassword) {
            showToast("Super Admin login successful!", "success");
            setTimeout(() => {
              document.getElementById('loadingOverlay').classList.remove('active');
              showScreen('superAdminPanel');
              // Initialize dashboard with real-time listeners
              initializeDashboard();
            }, 1000);
          } else {
            throw new Error("Invalid password");
          }
        } else {
          // If document doesn't exist, check default passwords
          const defaultPasswords = ["admin123", "password", "superadmin", "meta"];
          if (defaultPasswords.includes(password.toLowerCase())) {
            showToast("Super Admin login successful!", "success");
            setTimeout(() => {
              document.getElementById('loadingOverlay').classList.remove('active');
              showScreen('superAdminPanel');
              // Initialize dashboard with real-time listeners
              initializeDashboard();
            }, 1000);
          } else {
            throw new Error("Invalid password");
          }
        }
      } catch (error) {
        console.error("Login error:", error);
        errorText.textContent = error.message || "Invalid password. Try: admin123";
        errorDiv.classList.add('show');
        document.getElementById('loadingOverlay').classList.remove('active');
      }
    }

    // Update last update time
    function updateLastUpdateTime() {
      const now = new Date();
      window.votingState.lastUpdate = now;
      const timeString = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      document.querySelectorAll('#lastUpdateTime').forEach(el => {
        el.textContent = timeString;
      });
    }

    // Initialize the Global Dashboard
    function initializeDashboard() {
      // Clear existing listeners
      cleanupFirestoreListeners();
      
      // Load initial data
      loadDashboardStats();
      loadActivityFeed();
      loadOrgOverview();
      
      // Initialize charts
      setTimeout(() => {
        initCharts();
      }, 100);
      
      // Set up real-time listeners for data synchronization
      setupRealtimeListeners();
      
      showToast("Global Dashboard loaded with real-time data synchronization", "success");
    }
    
    // Set up real-time Firebase listeners
    function setupRealtimeListeners() {
      if (!firestore) return;
      
      // Listen for new organizations
      const orgsListener = firestore.collection(COLLECTIONS.ORGANIZATIONS)
        .onSnapshot((snapshot) => {
          const count = snapshot.size;
          window.votingState.syncStatus.organizations.count = count;
          window.votingState.syncStatus.organizations.lastSync = new Date();
          
          // Update UI
          document.getElementById('statOrganizations').textContent = count;
          document.getElementById('syncOrgsCount').textContent = count;
          document.getElementById('syncOrgsTime').textContent = 'Just now';
          
          // Update dashboard stats
          loadDashboardStats();
          loadOrgOverview();
          
          // Log activity
          if (window.votingState.activityLogging) {
            logActivity(`Organizations updated: ${count} total`);
          }
        }, (error) => {
          console.error("Error listening to organizations:", error);
        });
      
      // Listen for voters
      const votersListener = firestore.collection(COLLECTIONS.VOTERS)
        .onSnapshot((snapshot) => {
          const count = snapshot.size;
          window.votingState.syncStatus.voters.count = count;
          window.votingState.syncStatus.voters.lastSync = new Date();
          
          // Update UI
          document.getElementById('syncVotersCount').textContent = count;
          document.getElementById('syncVotersTime').textContent = 'Just now';
          
          // Update total voters stat
          const totalVoters = count;
          document.getElementById('statTotalVoters').textContent = totalVoters.toLocaleString();
          
          // Log activity for new voters
          snapshot.docChanges().forEach(change => {
            if (change.type === 'added' && window.votingState.activityLogging) {
              const voterData = change.doc.data();
              logActivity(`New voter added: ${voterData.email || voterData.phone}`);
            }
          });
        });
      
      // Listen for positions
      const positionsListener = firestore.collection(COLLECTIONS.POSITIONS)
        .onSnapshot((snapshot) => {
          const count = snapshot.size;
          window.votingState.syncStatus.positions.count = count;
          window.votingState.syncStatus.positions.lastSync = new Date();
          
          document.getElementById('syncPositionsCount').textContent = count;
          document.getElementById('syncPositionsTime').textContent = 'Just now';
        });
      
      // Listen for candidates
      const candidatesListener = firestore.collection(COLLECTIONS.CANDIDATES)
        .onSnapshot((snapshot) => {
          const count = snapshot.size;
          window.votingState.syncStatus.candidates.count = count;
          window.votingState.syncStatus.candidates.lastSync = new Date();
          
          document.getElementById('syncCandidatesCount').textContent = count;
          document.getElementById('syncCandidatesTime').textContent = 'Just now';
        });
      
      // Listen for votes
      const votesListener = firestore.collection(COLLECTIONS.VOTES)
        .onSnapshot((snapshot) => {
          const count = snapshot.size;
          window.votingState.syncStatus.votes.count = count;
          window.votingState.syncStatus.votes.lastSync = new Date();
          
          document.getElementById('syncVotesCount').textContent = count;
          document.getElementById('syncVotesTime').textContent = 'Just now';
          
          // Update votes today
          const today = new Date().toISOString().split('T')[0];
          const votesToday = snapshot.docs.filter(doc => {
            const voteDate = doc.data().timestamp?.toDate()?.toISOString().split('T')[0];
            return voteDate === today;
          }).length;
          
          document.getElementById('statVotesToday').textContent = votesToday.toLocaleString();
          
          // Update charts
          updateVotesChart();
        });
      
      // Listen for elections
      const electionsListener = firestore.collection(COLLECTIONS.ELECTIONS)
        .onSnapshot((snapshot) => {
          const activeElections = snapshot.docs.filter(doc => {
            const data = doc.data();
            return data.status === 'active' || data.status === 'ongoing';
          }).length;
          
          document.getElementById('statActiveElections').textContent = activeElections;
          
          // Update elections chart
          updateElectionsChart(snapshot);
        });
      
      // Listen for system logs
      const logsListener = firestore.collection(COLLECTIONS.SYSTEM_LOGS)
        .orderBy('timestamp', 'desc')
        .limit(10)
        .onSnapshot((snapshot) => {
          updateActivityFeed(snapshot);
        });
      
      // Store listeners for cleanup
      window.votingState.firestoreListeners = [
        orgsListener, votersListener, positionsListener,
        candidatesListener, votesListener, electionsListener,
        logsListener
      ];
    }
    
    // Clean up Firestore listeners
    function cleanupFirestoreListeners() {
      window.votingState.firestoreListeners.forEach(unsubscribe => {
        if (unsubscribe) unsubscribe();
      });
      window.votingState.firestoreListeners = [];
    }
    
    // Log activity to Firestore
    async function logActivity(message, type = 'info') {
      if (!firestore || !window.votingState.activityLogging) return;
      
      try {
        await firestore.collection(COLLECTIONS.SYSTEM_LOGS).add({
          message,
          type,
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          source: 'system'
        });
      } catch (error) {
        console.error("Error logging activity:", error);
      }
    }
    
    // Load dashboard statistics from Firestore
    async function loadDashboardStats() {
      if (!firestore) return;
      
      try {
        // Get organizations count
        const orgsSnapshot = await firestore.collection(COLLECTIONS.ORGANIZATIONS).get();
        const orgsCount = orgsSnapshot.size;
        
        // Get active elections count
        const electionsSnapshot = await firestore.collection(COLLECTIONS.ELECTIONS).get();
        const activeElections = electionsSnapshot.docs.filter(doc => {
          const data = doc.data();
          return data.status === 'active' || data.status === 'ongoing';
        }).length;
        
        // Get votes count for today
        const today = new Date().toISOString().split('T')[0];
        const votesSnapshot = await firestore.collection(COLLECTIONS.VOTES).get();
        const votesToday = votesSnapshot.docs.filter(doc => {
          const voteDate = doc.data().timestamp?.toDate()?.toISOString().split('T')[0];
          return voteDate === today;
        }).length;
        
        // Get total voters
        const votersSnapshot = await firestore.collection(COLLECTIONS.VOTERS).get();
        const totalVoters = votersSnapshot.size;
        
        // Calculate average turnout (simplified)
        const avgTurnout = 68; // This would be calculated from election data
        
        // Get pending approvals
        const approvalsSnapshot = await firestore.collection(COLLECTIONS.APPROVALS)
          .where('status', '==', 'pending').get();
        const pendingApprovals = approvalsSnapshot.size;
        
        // Update UI
        document.getElementById('statOrganizations').textContent = orgsCount;
        document.getElementById('statActiveElections').textContent = activeElections;
        document.getElementById('statVotesToday').textContent = votesToday.toLocaleString();
        document.getElementById('statTotalVoters').textContent = totalVoters.toLocaleString();
        document.getElementById('statAvgTurnout').textContent = avgTurnout + '%';
        document.getElementById('statPendingApprovals').textContent = pendingApprovals;
        
        // Update change indicators
        document.getElementById('statOrgsChange').textContent = orgsCount > 0 ? `+${Math.floor(orgsCount * 0.1)} this month` : 'No data';
        document.getElementById('statElectionsChange').textContent = activeElections > 0 ? 'Live' : 'None';
        document.getElementById('statVotesChange').textContent = votesToday > 0 ? `+${Math.floor(votesToday * 0.14)}% from yesterday` : 'No votes';
        document.getElementById('statVotersChange').textContent = totalVoters > 0 ? `+${Math.floor(totalVoters * 0.06)} this week` : 'No voters';
        document.getElementById('statTurnoutChange').textContent = avgTurnout > 0 ? `+${Math.floor(avgTurnout * 0.05)}% trend` : 'No data';
        document.getElementById('statApprovalsChange').textContent = pendingApprovals > 0 ? 'Needs attention' : 'All caught up';
        
      } catch (error) {
        console.error("Error loading dashboard stats:", error);
      }
    }
    
    // Load activity feed from Firestore
    function updateActivityFeed(snapshot) {
      const activityFeed = document.getElementById('activityFeed');
      if (!activityFeed) return;
      
      if (snapshot.empty) {
        activityFeed.innerHTML = '<div class="subtext" style="text-align: center; padding: 20px">No recent activity</div>';
        return;
      }
      
      const activities = snapshot.docs.map(doc => {
        const data = doc.data();
        const time = data.timestamp?.toDate ? data.timestamp.toDate() : new Date();
        const timeAgo = getTimeAgo(time);
        
        let icon = 'fas fa-info-circle';
        let color = 'var(--secondary)';
        
        if (data.type === 'success') {
          icon = 'fas fa-check-circle';
          color = 'var(--accent)';
        } else if (data.type === 'error') {
          icon = 'fas fa-exclamation-circle';
          color = 'var(--danger)';
        } else if (data.type === 'warning') {
          icon = 'fas fa-exclamation-triangle';
          color = '#ffc832';
        } else if (data.type === 'vote') {
          icon = 'fas fa-vote-yea';
          color = 'var(--primary)';
        } else if (data.type === 'org') {
          icon = 'fas fa-building';
          color = 'var(--primary)';
        } else if (data.type === 'ec') {
          icon = 'fas fa-user-shield';
          color = 'var(--secondary)';
        } else if (data.type === 'invite') {
          icon = 'fas fa-mail-bulk';
          color = 'var(--accent)';
        }
        
        return {
          icon,
          text: data.message,
          time: timeAgo,
          color
        };
      });
      
      activityFeed.innerHTML = activities.map(activity => `
        <div class="activity-item">
          <div class="activity-icon" style="background: ${activity.color}20; border: 1px solid ${activity.color}40">
            <i class="${activity.icon}" style="color: ${activity.color}"></i>
          </div>
          <div class="activity-content">
            <p class="activity-text">${activity.text}</p>
            <div class="activity-time">${activity.time}</div>
          </div>
        </div>
      `).join('');
    }
    
    // =========================================================
    // BULK INVITE SYSTEM
    // =========================================================
    
    // Setup drag and drop for bulk invite
    function setupDragAndDrop() {
      const csvUploadArea = document.getElementById('csvUploadArea');
      const excelUploadArea = document.getElementById('excelUploadArea');
      
      if (csvUploadArea) {
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
          csvUploadArea.addEventListener(eventName, preventDefaults, false);
        });
        
        ['dragenter', 'dragover'].forEach(eventName => {
          csvUploadArea.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
          csvUploadArea.addEventListener(eventName, unhighlight, false);
        });
        
        csvUploadArea.addEventListener('drop', handleDrop, false);
      }
      
      if (excelUploadArea) {
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
          excelUploadArea.addEventListener(eventName, preventDefaults, false);
        });
        
        ['dragenter', 'dragover'].forEach(eventName => {
          excelUploadArea.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
          excelUploadArea.addEventListener(eventName, unhighlight, false);
        });
        
        excelUploadArea.addEventListener('drop', handleExcelDrop, false);
      }
    }
    
    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }
    
    function highlight(e) {
      e.currentTarget.classList.add('dragover');
    }
    
    function unhighlight(e) {
      e.currentTarget.classList.remove('dragover');
    }
    
    function handleDrop(e) {
      const dt = e.dataTransfer;
      const files = dt.files;
      handleCSVFiles(files);
    }
    
    function handleExcelDrop(e) {
      const dt = e.dataTransfer;
      const files = dt.files;
      handleExcelFiles(files);
    }
    
    // Show bulk invite tab
    function showBulkTab(tabName) {
      // Hide all tabs
      document.querySelectorAll('.bulk-invite-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      document.querySelectorAll('.bulk-invite-container').forEach(container => {
        container.style.display = 'none';
      });
      
      // Show selected tab
      document.querySelector(`.bulk-invite-tab[onclick*="${tabName}"]`).classList.add('active');
      document.getElementById(`bulkTab-${tabName}`).style.display = 'block';
    }
    
    // Preview bulk voters from manual entry
    function previewBulkVoters() {
      const text = document.getElementById('bulkVoterText').value;
      const previewContainer = document.getElementById('manualPreview');
      
      if (!text.trim()) {
        previewContainer.innerHTML = '<div class="subtext" style="text-align: center; padding: 20px">No voters entered</div>';
        return;
      }
      
      const lines = text.split('\n').filter(line => line.trim());
      const voters = [];
      
      lines.forEach((line, index) => {
        const parts = line.split(',').map(part => part.trim());
        if (parts.length >= 2) {
          voters.push({
            id: index + 1,
            credential: parts[0],
            name: parts[1],
            pin: parts[2] || Math.floor(1000 + Math.random() * 9000).toString()
          });
        }
      });
      
      if (voters.length === 0) {
        previewContainer.innerHTML = '<div class="subtext" style="text-align: center; padding: 20px">No valid voters found. Use format: Email/Phone, Name, PIN(optional)</div>';
        return;
      }
      
      window.votingState.bulkInvite.currentVoters = voters;
      
      const previewHTML = voters.map(voter => `
        <div class="bulk-preview-item">
          <div class="bulk-preview-avatar">
            <i class="fas fa-user"></i>
          </div>
          <div class="bulk-preview-info">
            <div class="bulk-preview-name">${voter.name}</div>
            <div class="bulk-preview-email">${voter.credential}</div>
          </div>
          <div class="bulk-preview-status">PIN: ${voter.pin}</div>
        </div>
      `).join('');
      
      previewContainer.innerHTML = previewHTML;
      
      // Update send button
      document.getElementById('sendBulkBtn').innerHTML = `<i class="fas fa-paper-plane"></i> Send ${voters.length} Invites`;
    }
    
    // Send bulk invites
    async function sendBulkInvites() {
      const voters = window.votingState.bulkInvite.currentVoters;
      const orgId = window.votingState.currentOrgId;
      
      if (!voters || voters.length === 0) {
        showToast("No voters to invite", "error");
        return;
      }
      
      if (!orgId) {
        showToast("No organization selected", "error");
        return;
      }
      
      // Show progress bar
      document.getElementById('bulkProgress').style.display = 'block';
      document.getElementById('progressFill').style.width = '0%';
      document.getElementById('progressCurrent').textContent = '0';
      document.getElementById('progressTotal').textContent = voters.length.toString();
      document.getElementById('progressStatus').textContent = 'Processing...';
      
      window.votingState.bulkInvite.processing = true;
      window.votingState.bulkInvite.progress = 0;
      window.votingState.bulkInvite.total = voters.length;
      
      let successCount = 0;
      let failedCount = 0;
      
      for (let i = 0; i < voters.length; i++) {
        if (!window.votingState.bulkInvite.processing) {
          showToast("Bulk invite cancelled", "warning");
          break;
        }
        
        const voter = voters[i];
        
        try {
          // Save voter to Firestore
          await firestore.collection(COLLECTIONS.VOTERS).add({
            organizationId: orgId,
            email: voter.credential.includes('@') ? voter.credential : null,
            phone: voter.credential.includes('@') ? null : voter.credential,
            name: voter.name,
            pin: voter.pin,
            status: 'invited',
            invitedAt: firebase.firestore.FieldValue.serverTimestamp(),
            invitedBy: 'EC',
            voted: false,
            voteTimestamp: null
          });
          
          // Log invite
          await firestore.collection(COLLECTIONS.INVITES).add({
            organizationId: orgId,
            voterCredential: voter.credential,
            voterName: voter.name,
            method: 'bulk_manual',
            status: 'sent',
            sentAt: firebase.firestore.FieldValue.serverTimestamp(),
            batchId: `batch_${Date.now()}`
          });
          
          successCount++;
          
          // Log activity
          logActivity(`Bulk invite sent to ${voter.name} (${voter.credential})`, 'invite');
          
        } catch (error) {
          console.error(`Failed to invite ${voter.name}:`, error);
          failedCount++;
          
          // Log failed invite
          await firestore.collection(COLLECTIONS.INVITES).add({
            organizationId: orgId,
            voterCredential: voter.credential,
            voterName: voter.name,
            method: 'bulk_manual',
            status: 'failed',
            error: error.message,
            sentAt: firebase.firestore.FieldValue.serverTimestamp(),
            batchId: `batch_${Date.now()}`
          });
        }
        
        // Update progress
        window.votingState.bulkInvite.progress = i + 1;
        const progressPercent = Math.round(((i + 1) / voters.length) * 100);
        
        document.getElementById('progressFill').style.width = `${progressPercent}%`;
        document.getElementById('progressCurrent').textContent = (i + 1).toString();
        document.getElementById('progressStatus').textContent = `Processing... ${i + 1}/${voters.length}`;
        
        // Small delay to show progress
        await new Promise(resolve => setTimeout(resolve, 100));
      }
      
      window.votingState.bulkInvite.processing = false;
      
      // Show completion message
      if (successCount > 0) {
        document.getElementById('progressStatus').innerHTML = `<span class="badge success">Completed: ${successCount} sent, ${failedCount} failed</span>`;
        showToast(`Bulk invite completed: ${successCount} sent, ${failedCount} failed`, successCount > 0 ? 'success' : 'warning');
        
        // Update EC dashboard stats
        updateECVoterStats();
        
        // Log bulk activity
        logActivity(`Bulk invite completed: ${successCount} voters invited to organization ${orgId}`, 'invite');
      } else {
        document.getElementById('progressStatus').innerHTML = `<span class="badge danger">Failed: All ${failedCount} invites failed</span>`;
        showToast(`Bulk invite failed: All ${failedCount} invites failed`, 'error');
      }
      
      // Hide progress after 3 seconds
      setTimeout(() => {
        const bp=document.getElementById('bulkProgress'); if(bp) bp.style.display='none';
        // Clear the textarea
        document.getElementById('bulkVoterText').value = '';
        window.votingState.bulkInvite.currentVoters = [];
      }, 3000);
    }
    
    // Handle CSV file upload
    function handleCSVUpload(input) {
      handleCSVFiles(input.files);
    }
    
    function handleCSVFiles(files) {
      if (files.length === 0) return;
      
      const file = files[0];
      if (!file.name.toLowerCase().endsWith('.csv')) {
        showToast("Please upload a CSV file", "error");
        return;
      }
      
      if (file.size > 5 * 1024 * 1024) {
        showToast("File size too large. Maximum 5MB", "error");
        return;
      }
      
      // Show file info
      const csvPreview = document.getElementById('csvPreview');
      csvPreview.style.display = 'block';
      csvPreview.innerHTML = `
        <div class="selected-file">
          <div class="file-icon">
            <i class="fas fa-file-csv"></i>
          </div>
          <div class="file-info">
            <div class="file-name">${file.name}</div>
            <div class="file-size">${formatFileSize(file.size)}</div>
          </div>
          <div class="remove-file" onclick="removeCSVFile()">
            <i class="fas fa-times"></i>
          </div>
        </div>
        <div style="text-align: center; padding: 20px">
          <div class="spinner" style="width: 24px; height: 24px; margin: 0 auto 10px"></div>
          <div class="subtext">Processing CSV file...</div>
        </div>
      `;
      
      // Enable process button
      document.getElementById('processCSVBtn').disabled = false;
      
      // Store file for processing
      window.votingState.csvFile = file;
      
      // Preview CSV
      previewCSVFile(file);
    }
    
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    function removeCSVFile() {
      document.getElementById('csvFileInput').value = '';
      document.getElementById('csvPreview').style.display = 'none';
      document.getElementById('processCSVBtn').disabled = true;
      delete window.votingState.csvFile;
    }
    
    function previewCSVFile(file) {
      const reader = new FileReader();
      
      reader.onload = function(e) {
        try {
          const csvContent = e.target.result;
          const lines = csvContent.split('\n');
          
          // Parse CSV (simple parsing)
          const headers = lines[0].split(',').map(h => h.trim());
          const dataRows = lines.slice(1, Math.min(11, lines.length)).filter(line => line.trim());
          
          let tableHTML = '<table class="csv-table">';
          tableHTML += '<thead><tr>';
          headers.forEach(header => {
            tableHTML += `<th>${header}</th>`;
          });
          tableHTML += '</tr></thead><tbody>';
          
          dataRows.forEach(row => {
            const cells = row.split(',').map(cell => cell.trim());
            tableHTML += '<tr>';
            cells.forEach(cell => {
              tableHTML += `<td>${cell}</td>`;
            });
            tableHTML += '</tr>';
          });
          
          tableHTML += '</tbody></table>';
          
          if (lines.length > 11) {
            tableHTML += `<div class="subtext" style="text-align: center; margin-top: 10px">Showing 10 of ${lines.length - 1} rows</div>`;
          }
          
          document.getElementById('csvPreview').innerHTML = `
            <div class="selected-file">
              <div class="file-icon">
                <i class="fas fa-file-csv"></i>
              </div>
              <div class="file-info">
                <div class="file-name">${file.name}</div>
                <div class="file-size">${formatFileSize(file.size)} • ${lines.length - 1} rows</div>
              </div>
              <div class="remove-file" onclick="removeCSVFile()">
                <i class="fas fa-times"></i>
              </div>
            </div>
            ${tableHTML}
          `;
          
        } catch (error) {
          console.error("Error parsing CSV:", error);
          document.getElementById('csvPreview').innerHTML = `
            <div class="selected-file">
              <div class="file-icon">
                <i class="fas fa-file-csv"></i>
              </div>
              <div class="file-info">
                <div class="file-name">${file.name}</div>
                <div class="file-size">${formatFileSize(file.size)}</div>
              </div>
              <div class="remove-file" onclick="removeCSVFile()">
                <i class="fas fa-times"></i>
              </div>
            </div>
            <div style="text-align: center; padding: 20px; color: var(--danger)">
              <i class="fas fa-exclamation-circle"></i>
              <div>Error parsing CSV file</div>
            </div>
          `;
        }
      };
      
      reader.readAsText(file);
    }
    
    async function processCSVFile() {
      const file = window.votingState.csvFile;
      if (!file) {
        showToast("No CSV file selected", "error");
        return;
      }
      
      const reader = new FileReader();
      
      reader.onload = async function(e) {
        try {
          const csvContent = e.target.result;
          const lines = csvContent.split('\n').filter(line => line.trim());
          
          if (lines.length < 2) {
            showToast("CSV file is empty", "error");
            return;
          }
          
          const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
          const voters = [];
          
          // Find column indices
          const emailIndex = headers.findIndex(h => h.includes('email'));
          const phoneIndex = headers.findIndex(h => h.includes('phone'));
          const nameIndex = headers.findIndex(h => h.includes('name'));
          const pinIndex = headers.findIndex(h => h.includes('pin') || h.includes('password'));
          
          // Process rows
          for (let i = 1; i < lines.length; i++) {
            const cells = lines[i].split(',').map(cell => cell.trim());
            
            let credential = '';
            if (emailIndex >= 0 && cells[emailIndex]) {
              credential = cells[emailIndex];
            } else if (phoneIndex >= 0 && cells[phoneIndex]) {
              credential = cells[phoneIndex];
            }
            
            const name = nameIndex >= 0 ? cells[nameIndex] : `Voter ${i}`;
            const pin = pinIndex >= 0 ? cells[pinIndex] : Math.floor(1000 + Math.random() * 9000).toString();
            
            if (credential) {
              voters.push({
                credential,
                name,
                pin
              });
            }
          }
          
          if (voters.length === 0) {
            showToast("No valid voters found in CSV", "error");
            return;
          }
          
          // Store voters for sending
          window.votingState.bulkInvite.currentVoters = voters.map((v, i) => ({
            id: i + 1,
            ...v
          }));
          
          // Show preview
          const previewContainer = document.getElementById('manualPreview');
          const previewHTML = voters.map(voter => `
            <div class="bulk-preview-item">
              <div class="bulk-preview-avatar">
                <i class="fas fa-user"></i>
              </div>
              <div class="bulk-preview-info">
                <div class="bulk-preview-name">${voter.name}</div>
                <div class="bulk-preview-email">${voter.credential}</div>
              </div>
              <div class="bulk-preview-status">PIN: ${voter.pin}</div>
            </div>
          `).join('');
          
          previewContainer.innerHTML = previewHTML;
          
          // Update send button
          document.getElementById('sendBulkBtn').innerHTML = `<i class="fas fa-paper-plane"></i> Send ${voters.length} Invites`;
          
          // Switch to manual tab to show preview
          showBulkTab('manual');
          
          showToast(`CSV processed: ${voters.length} voters found`, "success");
          
        } catch (error) {
          console.error("Error processing CSV:", error);
          showToast("Error processing CSV file: " + error.message, "error");
        }
      };
      
      reader.readAsText(file);
    }
    
    // Handle Excel file upload
    function handleExcelUpload(input) {
      handleExcelFiles(input.files);
    }
    
    function handleExcelFiles(files) {
      if (files.length === 0) return;
      
      const file = files[0];
      const validExtensions = ['.xlsx', '.xls'];
      const fileExt = '.' + file.name.split('.').pop().toLowerCase();
      
      if (!validExtensions.includes(fileExt)) {
        showToast("Please upload an Excel file (.xlsx or .xls)", "error");
        return;
      }
      
      if (file.size > 10 * 1024 * 1024) {
        showToast("File size too large. Maximum 10MB", "error");
        return;
      }
      
      showToast("Excel file selected. Processing requires additional library.", "info");
      document.getElementById('processExcelBtn').disabled = false;
      window.votingState.excelFile = file;
    }
    
    async function processExcelFile() {
      showToast("Excel processing requires SheetJS library. Using manual entry instead.", "warning");
      showBulkTab('manual');
    }
    
    // Template selection
    let selectedTemplate = null;
    
    function selectTemplate(templateName) {
      selectedTemplate = templateName;
      
      // Remove active class from all templates
      document.querySelectorAll('.template-card').forEach(card => {
        card.classList.remove('active');
      });
      
      // Add active class to selected template
      event.currentTarget.classList.add('active');
      
      // Enable use template button
      document.getElementById('useTemplateBtn').disabled = false;
    }
    
    function useSelectedTemplate() {
      if (!selectedTemplate) return;
      
      let templateText = '';
      
      switch (selectedTemplate) {
        case 'university':
          templateText = `student1@university.edu, John Smith, 2024
student2@university.edu, Jane Doe, 2024
student3@university.edu, Bob Johnson, 2023
student4@university.edu, Alice Brown, 2023
student5@university.edu, Charlie Wilson, 2022`;
          break;
        case 'corporate':
          templateText = `employee1@company.com, Sarah Johnson, 5678
employee2@company.com, Michael Chen, 9012
employee3@company.com, Emily Davis, 3456
employee4@company.com, David Wilson, 7890
employee5@company.com, Lisa Thompson, 1234`;
          break;
        case 'community':
          templateText = `+1234567890, Robert Garcia, 1111
+0987654321, Maria Martinez, 2222
+1122334455, James Anderson, 3333
+5566778899, Patricia Lee, 4444
+6677889900, Thomas Clark, 5555`;
          break;
      }
      
      // Switch to manual tab and populate
      showBulkTab('manual');
      document.getElementById('bulkVoterText').value = templateText;
      previewBulkVoters();
      
      showToast(`Template "${selectedTemplate}" loaded`, "success");
    }
    
    // Cancel bulk invite
    function cancelBulkInvite() {
      window.votingState.bulkInvite.processing = false;
      const bp=document.getElementById('bulkProgress'); if(bp) bp.style.display='none';
      showToast("Bulk invite cancelled", "warning");
    }
    
    // Show invite history
    function showInviteHistory() {
      document.getElementById('inviteHistoryModal').classList.add('active');
      loadInviteHistory();
    }
    
    function closeInviteHistory() {
      document.getElementById('inviteHistoryModal').classList.remove('active');
    }
    
    async function loadInviteHistory() {
      const orgId = window.votingState.currentOrgId;
      if (!orgId || !firestore) return;
      
      try {
        const snapshot = await firestore.collection(COLLECTIONS.INVITES)
          .where('organizationId', '==', orgId)
          .orderBy('sentAt', 'desc')
          .limit(20)
          .get();
        
        const historyTable = document.getElementById('inviteHistoryTable');
        
        if (snapshot.empty) {
          historyTable.innerHTML = `
            <tr>
              <td colspan="5" style="text-align: center; padding: 40px">
                <div class="subtext">No invite history found</div>
              </td>
            </tr>
          `;
          return;
        }
        
        const rows = snapshot.docs.map(doc => {
          const data = doc.data();
          const time = data.sentAt?.toDate ? data.sentAt.toDate() : new Date();
          const timeString = time.toLocaleString();
          
          let statusClass = 'status-sent';
          let statusText = 'Sent';
          
          if (data.status === 'pending') {
            statusClass = 'status-pending';
            statusText = 'Pending';
          } else if (data.status === 'failed') {
            statusClass = 'status-failed';
            statusText = 'Failed';
          }
          
          return `
            <tr>
              <td>${timeString}</td>
              <td>${data.method || 'manual'}</td>
              <td>${data.voterName}</td>
              <td><span class="invite-status ${statusClass}">${statusText}</span></td>
              <td>${data.voterCredential}</td>
            </tr>
          `;
        }).join('');
        
        historyTable.innerHTML = rows;
        
      } catch (error) {
        console.error("Error loading invite history:", error);
        document.getElementById('inviteHistoryTable').innerHTML = `
          <tr>
            <td colspan="5" style="text-align: center; padding: 40px; color: var(--danger)">
              <i class="fas fa-exclamation-circle"></i>
              <div>Error loading history</div>
            </td>
          </tr>
        `;
      }
    }
    
    // Update EC voter stats
    function updateECVoterStats() {
      // This would update the EC dashboard voter statistics
      const voterCount = window.votingState.bulkInvite.currentVoters.length;
      document.getElementById('ecVoterCount').textContent = voterCount;
      document.getElementById('ecInvitedCount').textContent = voterCount;
    }
    
    // Switch to bulk invite tab from voters tab
    function switchToBulkInvite() {
      // Switch to bulk invite tab
      document.querySelectorAll('[data-ec-tab]').forEach(t => t.classList.remove('active'));
      document.querySelector('[data-ec-tab="bulk-invite"]').classList.add('active');
      document.querySelectorAll('[id^="ecContent-"]').forEach(content => {
        content.style.display = 'none';
      });
      document.getElementById('ecContent-bulk-invite').style.display = 'block';
    }
    
    // Helper function to get time ago
    function getTimeAgo(date) {
      const now = new Date();
      const diffMs = now - date;
      const diffSec = Math.floor(diffMs / 1000);
      const diffMin = Math.floor(diffSec / 60);
      const diffHour = Math.floor(diffMin / 60);
      
      if (diffSec < 60) return 'Just now';
      if (diffMin < 60) return `${diffMin} minute${diffMin !== 1 ? 's' : ''} ago`;
      if (diffHour < 24) return `${diffHour} hour${diffHour !== 1 ? 's' : ''} ago`;
      return date.toLocaleDateString();
    }
    
    // Load sync settings from localStorage
    function loadSyncSettings() {
      const realtimeSync = localStorage.getItem('enableRealtimeSync') !== 'false';
      const autoRefresh = localStorage.getItem('enableAutoRefresh') !== 'false';
      const activityLogging = localStorage.getItem('enableActivityLogging') !== 'false';
      
      window.votingState.realTimeSync = realtimeSync;
      window.votingState.autoRefresh = autoRefresh;
      window.votingState.activityLogging = activityLogging;
      
      // Update checkboxes if they exist
      if (document.getElementById('enableRealtimeSync')) {
        document.getElementById('enableRealtimeSync').checked = realtimeSync;
      }
      if (document.getElementById('enableAutoRefresh')) {
        document.getElementById('enableAutoRefresh').checked = autoRefresh;
      }
      if (document.getElementById('enableActivityLogging')) {
        document.getElementById('enableActivityLogging').checked = activityLogging;
      }
    }
    
    // Save sync settings
    function saveSyncSettings() {
      const realtimeSync = document.getElementById('enableRealtimeSync').checked;
      const autoRefresh = document.getElementById('enableAutoRefresh').checked;
      const activityLogging = document.getElementById('enableActivityLogging').checked;
      
      localStorage.setItem('enableRealtimeSync', realtimeSync);
      localStorage.setItem('enableAutoRefresh', autoRefresh);
      localStorage.setItem('enableActivityLogging', activityLogging);
      
      window.votingState.realTimeSync = realtimeSync;
      window.votingState.autoRefresh = autoRefresh;
      window.votingState.activityLogging = activityLogging;
      
      showToast('Sync settings saved successfully', 'success');
      
      // Update sync status
      if (realtimeSync) {
        setupRealtimeListeners();
      } else {
        cleanupFirestoreListeners();
      }
    }
    
    // Set dashboard time filter
    function setDashboardTimeFilter(filter) {
      window.votingState.dashboardTimeFilter = filter;
      
      // Update active button
      document.querySelectorAll('.time-filter-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
      
      // Refresh dashboard data
      refreshDashboard();
      showToast(`Time filter set to ${filter}`, 'info');
    }
    
    // Refresh dashboard
    function refreshDashboard() {
      showToast('Refreshing dashboard data...', 'info');
      
      // Update stats
      loadDashboardStats();
      loadOrgOverview();
      
      // Update charts
      updateVotesChart();
      updateElectionStatusChart && updateElectionStatusChart({});
      
      showToast('Dashboard refreshed successfully', 'success');
    }
    
    // Show all organizations
    function showAllOrganizations() {
      showToast('Showing all organizations in Organizations tab', 'info');
      
      // Switch to organizations tab
      document.querySelectorAll('[data-super-tab]').forEach(t => t.classList.remove('active'));
      document.querySelector('[data-super-tab="orgs"]').classList.add('active');
      document.querySelectorAll('[id^="superContent-"]').forEach(content => {
        content.style.display = 'none';
      });
      document.getElementById('superContent-orgs').style.display = 'block';
    }

    // EC Login function
    async function loginEC() {
      const orgId = document.getElementById('ec-org-id').value;
      const password = document.getElementById('ec-pass').value;
      
      if (!orgId || !password) {
        showToast("Please enter organization ID and password", "error");
        return;
      }
      
      // Show loading
      document.getElementById('loadingOverlay').classList.add('active');
      document.getElementById('loadingText').textContent = "Logging in...";
      
      try {
        // In a real implementation, this would verify EC credentials
        // For now, we'll simulate a successful login
        window.votingState.currentOrgId = orgId;
        window.votingState.currentOrgName = orgId;
        
        setTimeout(() => {
          document.getElementById('loadingOverlay').classList.remove('active');
          showScreen('ecPanel');
          showToast("EC login successful - Data syncing with global dashboard", "success");
          
          // Update EC panel with organization info
          document.getElementById('ecOrgName').textContent = orgId;
          document.getElementById('ecOrgIdDisplay').textContent = orgId;
          
          // Log activity
          logActivity(`EC logged into organization: ${orgId}`, 'ec');
        }, 1000);
        
      } catch (error) {
        console.error("EC login error:", error);
        document.getElementById('loadingOverlay').classList.remove('active');
        showToast("Login failed. Please check credentials.", "error");
      }
    }

    // Simulate real-time vote sync
    window.syncVoteWithDashboard = async function(voteData) {
      if (!window.votingState.realTimeSync || !firestore) return;
      
      try {
        // In a real implementation, this would save to Firestore
        // For now, we'll simulate the sync
        console.log("Syncing vote with global dashboard:", voteData);
        
        // Update local sync status
        window.votingState.syncStatus.votes.count++;
        window.votingState.syncStatus.votes.lastSync = new Date();
        
        showToast("Vote synced with global dashboard", "success");
        updateLastUpdateTime();
        
        // Log activity
        logActivity(`New vote recorded in organization ${voteData.organizationId}`, 'vote');
        
      } catch (error) {
        console.error("Error syncing vote:", error);
        showToast("Error syncing vote: " + error.message, "error");
      }
    };

    // Load election outcomes
    window.loadElectionOutcomes = function() {
      const outcomeBox = document.getElementById('ecOutcomeResults');
      if (!outcomeBox) return;
      
      outcomeBox.innerHTML = `
        <div style="text-align: center; padding: 40px 20px;">
          <div class="spinner" style="width: 40px; height: 40px; margin: 0 auto 15px;"></div>
          <div class="subtext">Loading real-time election outcomes...</div>
          <div class="real-time-indicator" style="margin-top: 10px;">
            <div class="pulse-dot"></div>
            <span>Syncing with global dashboard</span>
          </div>
        </div>
      `;
      
      // Simulate loading outcomes
      setTimeout(() => {
        window.updateElectionOutcomes();
      }, 1000);
    };

    // Update election outcomes display
    window.updateElectionOutcomes = function() {
      const outcomeBox = document.getElementById('ecOutcomeResults');
      if (!outcomeBox) return;
      
      // This is a simulation - in production, this would fetch real data from Firebase
      const mockResults = `
        <div class="position-result">
          <h3 class="position-title">President <span class="badge primary">Live</span></h3>
          <div class="candidate-result">
            <div class="candidate-info">
              <strong>John Doe</strong>
              <span class="subtext">Independent</span>
            </div>
            <div style="flex: 1; margin: 0 16px;">
              <div class="vote-bar">
                <div class="vote-fill" style="width: 65%"></div>
              </div>
              <div class="vote-count">
                <span>65%</span>
                <span>130 votes</span>
              </div>
            </div>
            <span class="winner-badge">WINNER</span>
          </div>
          <div class="candidate-result">
            <div class="candidate-info">
              <strong>Jane Smith</strong>
              <span class="subtext">Progressive Party</span>
            </div>
            <div style="flex: 1; margin: 0 16px;">
              <div class="vote-bar">
                <div class="vote-fill" style="width: 35%"></div>
              </div>
              <div class="vote-count">
                <span>35%</span>
                <span>70 votes</span>
              </div>
            </div>
          </div>
        </div>
      `;
      
      // Update statistics
      document.getElementById('totalVotes').textContent = '200';
      document.getElementById('voterTurnout').textContent = '67%';
      document.getElementById('positionsCount').textContent = '5';
      document.getElementById('candidatesCount').textContent = '12';
      
      outcomeBox.innerHTML = mockResults;
      updateLastUpdateTime();
      
      showToast("Outcomes updated with latest votes", "info");
    };

    // Basic event listeners for back buttons
    document.addEventListener('DOMContentLoaded', function() {
      // Back buttons
      document.querySelectorAll('[id$="-back"]').forEach(btn => {
        btn.addEventListener('click', () => showScreen('gatewayScreen'));
      });

      // Gateway buttons
      document.getElementById('btn-superadmin')?.addEventListener('click', () => showScreen('superAdminLoginScreen'));
      document.getElementById('btn-ec')?.addEventListener('click', () => showScreen('ecLoginScreen'));
      document.getElementById('btn-voter')?.addEventListener('click', () => showScreen('voterLoginScreen'));
      document.getElementById('btn-public')?.addEventListener('click', () => showScreen('publicScreen'));
      document.getElementById('btn-guest')?.addEventListener('click', () => showScreen('guestScreen'));

      // EC Login button
      document.getElementById('ec-login-btn')?.addEventListener('click', loginEC);

      // Tab switching for Super Admin
      document.querySelectorAll('[data-super-tab]').forEach(tab => {
        tab.addEventListener('click', function() {
          const tabId = this.getAttribute('data-super-tab');
          document.querySelectorAll('[data-super-tab]').forEach(t => t.classList.remove('active'));
          this.classList.add('active');
          document.querySelectorAll('[id^="superContent-"]').forEach(content => {
            content.style.display = 'none';
          });
          document.getElementById(`superContent-${tabId}`).style.display = 'block';
          
          // Initialize dashboard when switching to it
          if (tabId === 'dashboard') {
            setTimeout(() => {
              initializeDashboard();
            }, 100);
          }
        });
      });

      // Tab switching for EC
      document.querySelectorAll('[data-ec-tab]').forEach(tab => {
        tab.addEventListener('click', function() {
          const tabId = this.getAttribute('data-ec-tab');
          document.querySelectorAll('[data-ec-tab]').forEach(t => t.classList.remove('active'));
          this.classList.add('active');
          document.querySelectorAll('[id^="ecContent-"]').forEach(content => {
            content.style.display = 'none';
          });
          document.getElementById(`ecContent-${tabId}`).style.display = 'block';
          
          // Special handling for Outcomes tab
          if (tabId === 'outcomes') {
            if (typeof window.loadElectionOutcomes === 'function') {
              window.loadElectionOutcomes();
            }
          }
          
          // Special handling for Bulk Invite tab
          if (tabId === 'bulk-invite') {
            // Reset any previous bulk invite state
            window.votingState.bulkInvite.processing = false;
            const bp=document.getElementById('bulkProgress'); if(bp) bp.style.display='none';
          }
        });
      });

      // Logout buttons
      document.querySelectorAll('.logout-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          // Clean up listeners
          cleanupFirestoreListeners();
          
          // Clear sync state
          window.votingState.currentOrgId = null;
          window.votingState.currentOrgName = null;
          showScreen('gatewayScreen');
        });
      });
      
      // Super Admin login button with Enter key support
      document.getElementById('super-admin-pass')?.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          loginSuperAdmin();
        }
      });
      
      // Voter login button
      document.getElementById('voterLoginBtn')?.addEventListener('click', function() {
        const orgId = document.getElementById('voterOrgIdInput').value;
        const credential = document.getElementById('voterCredentialInput').value;
        
        if (!orgId || !credential) {
          showToast("Please enter organization ID and credentials", "error");
          return;
        }
        
        // Set current org for sync
        window.votingState.currentOrgId = orgId;
        showScreen('votingScreen');
        showToast("Logged in - Votes will sync with global dashboard", "success");
      });
      <div id="voterLiveDashboard" class="screen hidden">
  <div class="card">
    <h2 id="voterElectionStatus"></h2>
    <p class="muted">You have already voted. Live results are shown below.</p>
    <div id="resultsByPosition"></div>
  </div>
</div>

      // Real-time sync checkbox in EC settings
      document.getElementById('realTimeSync')?.addEventListener('change', function(e) {
        window.votingState.realTimeSync = e.target.checked;
        showToast(
          e.target.checked ? "Real-time sync enabled" : "Real-time sync disabled",
          e.target.checked ? "success" : "warning"
        );
      });
    });

    // Placeholder functions for demonstration
    function showCreateOrgModal() {
      showToast('Create Organization modal would open here', 'info');
    }
    
    function changeSuperPassword() {
      showToast('Password changed successfully!', 'success');
    }
    
    function checkFirebaseStatus() {
      if (firestore) {
        showToast('Firebase is connected and working - Real-time sync active', 'success');
      } else {
        showToast('Firebase is not connected', 'error');
      }
    }
    
    function resetAppData() {
      if (confirm("Are you sure you want to reset all app data? This cannot be undone!")) {
        showToast('App data reset initiated', 'warning');
      }
    }
    
    function showAddVoterModal() {
      showToast('Add Voter modal would open here', 'info');
    }
    
    function showAddPositionModal() {
      showToast('Add Position modal would open here', 'info');
    }
    
    function showAddCandidateModal() {
      showToast('Add Candidate modal would open here', 'info');
    }
    
    function saveElectionSettings() {
      showToast('Election settings saved!', 'success');
    }
    
    function submitForApprovalFinal() {
      showToast('Submitted for approval!', 'success');
    }
    
    function submitVote() {
      const orgId = window.votingState.currentOrgId;
      if (!orgId) {
        showToast("No organization selected", "error");
        return;
      }
      
      showToast('Vote submitted successfully!', 'success');
      
      // Simulate vote sync with global dashboard
      setTimeout(() => {
        if (window.votingState.realTimeSync) {
          window.syncVoteWithDashboard({
            organizationId: orgId,
            voterId: 'demo-voter',
            timestamp: new Date().toISOString(),
            positions: ['President']
          });
        }
      }, 1000);
    }
    
    // Initialize last update time
    updateLastUpdateTime();
    
    // Auto-refresh dashboard if enabled
    setInterval(() => {
      if (window.votingState.autoRefresh && 
          document.getElementById('superContent-dashboard')?.style.display !== 'none') {
        refreshDashboard();
      }
    }, 30000); // Update every 30 seconds
  
    /* ======================================================
       GLOBAL DASHBOARD: 100% ACCURATE TOTALS (from subcollections)
       + CHARTS (safe)
       + DASHBOARD PDF EXPORT
       NOTE: This overrides earlier functions if present.
       ====================================================== */

    function initCharts(){
      try{
        const vctx = document.getElementById('votesChart')?.getContext?.('2d');
        const ectx = document.getElementById('electionsChart')?.getContext?.('2d');
        if(window.Chart && vctx){
          if(votesChart) { votesChart.destroy(); votesChart=null; }
          votesChart = new Chart(vctx, {
            type: 'bar',
            data: { labels: [], datasets: [{ label: 'Votes', data: [] }] },
            options: { responsive:true, maintainAspectRatio:false }
          });
        }
        if(window.Chart && ectx){
          if(electionsChart) { electionsChart.destroy(); electionsChart=null; }
          electionsChart = new Chart(ectx, {
            type: 'pie',
            data: { labels: ['Not started','In progress','Ended'], datasets: [{ data: [0,0,0] }] },
            options: { responsive:true, maintainAspectRatio:false }
          });
        }
      }catch(err){
        console.warn("initCharts failed", err);
      }
    }

    function updateVotesChart(points){
      try{
        if(!votesChart) return;
        const labels = (points||[]).map(p=>p.label);
        const data = (points||[]).map(p=>p.count);
        votesChart.data.labels = labels;
        votesChart.data.datasets[0].data = data;
        votesChart.update();
      }catch(err){
        console.warn("updateVotesChart failed", err);
      }
    }

    function updateElectionStatusChart(dist){
      try{
        if(!electionsChart) return;
        const d = dist || {notStarted:0,inProgress:0,ended:0};
        electionsChart.data.datasets[0].data = [d.notStarted||0, d.inProgress||0, d.ended||0];
        electionsChart.update();
      }catch(err){
        console.warn("updateElectionStatusChart failed", err);
      }
    }

    function _isInProgressFromOrg(org){
      const s = org?.electionSettings?.startTime ? new Date(org.electionSettings.startTime).getTime() : null;
      const e = org?.electionSettings?.endTime ? new Date(org.electionSettings.endTime).getTime() : null;
      const now = Date.now();
      if(s && now >= s){
        if(e && now > e) return "ended";
        return "inProgress";
      }
      const st = String(org?.electionStatus||"").toLowerCase();
      if(st.includes("end")) return "ended";
      if(st.includes("start") || st.includes("progress")) return "inProgress";
      return "notStarted";
    }

    async function loadDashboardStats(){
      if(!firestore) return;
      try{
        // Pull orgs
        const orgSnap = await firestore.collection(COLLECTIONS.ORGANIZATIONS).get();
        const orgDocs = orgSnap.docs || [];
        const totalOrgs = orgDocs.length;

        // Aggregate totals from subcollections (100% accurate)
        let totalVoters=0, totalVotes=0, totalPositions=0, totalCandidates=0;
        const dist = {notStarted:0,inProgress:0,ended:0};

        // votes per hour last 24h (best effort if timestamp exists)
        const hourBuckets = new Array(24).fill(0);

        // Per-org parallel aggregation (still accurate)
        await Promise.all(orgDocs.map(async (od)=>{
          const orgId = od.id;
          const org = od.data()||{};
          dist[_isInProgressFromOrg(org)]++;

          const base = firestore.collection(COLLECTIONS.ORGANIZATIONS).doc(orgId);
          const [votersS, votesS, posS, candS] = await Promise.all([
            base.collection(COLLECTIONS.VOTERS).get(),
            base.collection(COLLECTIONS.VOTES).get(),
            base.collection(COLLECTIONS.POSITIONS).get(),
            base.collection(COLLECTIONS.CANDIDATES).get()
          ]);

          totalVoters += votersS.size || 0;
          totalVotes += votesS.size || 0;
          totalPositions += posS.size || 0;
          totalCandidates += candS.size || 0;

          // best-effort time chart
          const now = Date.now();
          votesS.forEach(v=>{
            const d=v.data()||{};
            const ts = d.createdAt || d.castAt || d.timestamp || null;
            const ms = ts?.toMillis ? ts.toMillis() : (ts ? new Date(ts).getTime() : null);
            if(!ms) return;
            const diffH = Math.floor((now - ms) / (1000*60*60));
            if(diffH>=0 && diffH<24){
              hourBuckets[23-diffH] += 1; // oldest -> newest
            }
          });
        }));

        // Update stat cards
        const elOrgs = document.getElementById("statOrganizations");
        if(elOrgs) elOrgs.textContent = String(totalOrgs);

        const elActive = document.getElementById("statActiveElections");
        if(elActive) elActive.textContent = String(dist.inProgress || 0);

        const elVotesToday = document.getElementById("statVotesToday");
        if(elVotesToday) elVotesToday.textContent = String(totalVotes);

        const elVoters = document.getElementById("statTotalVoters");
        if(elVoters) elVoters.textContent = String(totalVoters);

        const turnout = totalVoters ? Math.round((totalVotes/totalVoters)*100) : 0;
        const elTurnout = document.getElementById("statAvgTurnout");
        if(elTurnout) elTurnout.textContent = String(turnout) + "%";

        // Update live sync table counts
        document.getElementById("syncOrgsCount")?.textContent = String(totalOrgs);
        document.getElementById("syncVotersCount")?.textContent = String(totalVoters);
        document.getElementById("syncPositionsCount")?.textContent = String(totalPositions);
        document.getElementById("syncCandidatesCount")?.textContent = String(totalCandidates);
        document.getElementById("syncVotesCount")?.textContent = String(totalVotes);

        const nowTxt = "Just now";
        document.getElementById("syncOrgsTime")?.textContent = nowTxt;
        document.getElementById("syncVotersTime")?.textContent = nowTxt;
        document.getElementById("syncPositionsTime")?.textContent = nowTxt;
        document.getElementById("syncCandidatesTime")?.textContent = nowTxt;
        document.getElementById("syncVotesTime")?.textContent = nowTxt;

        // Update charts
        const labels = [];
        for(let i=23;i>=0;i--){
          labels.push(i===0 ? "now" : `${i}h`);
        }
        const points = labels.map((l,idx)=>({label:l, count: hourBuckets[idx]}));
        updateVotesChart(points);
        updateElectionStatusChart(dist);

      }catch(err){
        console.error("Error loading dashboard stats:", err);
        showToast("Error loading dashboard stats: "+(err?.message||err), "error");
      }
    }

    // Dashboard PDF Export (downloadable)
    async function exportDashboardPDF(){
      try{
        if(!window.jspdf || !window.jspdf.jsPDF){
          showToast("PDF library not loaded", "error");
          return;
        }
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({orientation:"p", unit:"pt", format:"a4"});

        const title = "Neon Voting System - Global Dashboard";
        doc.setFontSize(16);
        doc.text(title, 40, 50);

        doc.setFontSize(10);
        doc.text("Generated: " + new Date().toLocaleString(), 40, 70);

        const stats = [
          ["Total Organizations", document.getElementById("statOrganizations")?.textContent || "0"],
          ["Active Elections", document.getElementById("statActiveElections")?.textContent || "0"],
          ["Total Votes", document.getElementById("statVotesToday")?.textContent || "0"],
          ["Total Voters", document.getElementById("statTotalVoters")?.textContent || "0"],
          ["Avg Turnout", document.getElementById("statAvgTurnout")?.textContent || "0%"],
        ];

        if(doc.autoTable){
          doc.autoTable({
            startY: 90,
            head: [["Metric","Value"]],
            body: stats,
            theme: "grid",
            styles: { fontSize: 10 }
          });
        }else{
          let y=95;
          stats.forEach(([k,v])=>{ doc.text(`${k}: ${v}`, 40, y); y+=14; });
        }

        // Organization list
        if(firestore){
          const orgSnap = await firestore.collection(COLLECTIONS.ORGANIZATIONS).get();
          const rows = [];
          orgSnap.forEach(d=>{
            const o=d.data()||{};
            rows.push([d.id, o.name||o.orgName||"—", String(o.electionStatus||"—")]);
          });
          const startY = (doc.lastAutoTable?.finalY || 180) + 20;
          if(doc.autoTable){
            doc.autoTable({
              startY,
              head: [["Org ID","Name","Status"]],
              body: rows,
              theme: "striped",
              styles: { fontSize: 9 }
            });
          }
        }

        doc.save("Neon-Global-Dashboard.pdf");
        showToast("Dashboard PDF downloaded", "success");
      }catch(err){
        console.error(err);
        showToast("PDF export failed: "+(err?.message||err), "error");
      }
    }

    // Make Export Results (PDF) also export Dashboard PDF when orgId missing
    const _oldExportResultsPDF = window.exportResultsPDF;
    window.exportResultsPDF = function(orgId){
      if(!orgId){ return exportDashboardPDF(); }
      if(typeof _oldExportResultsPDF === "function") return _oldExportResultsPDF(orgId);
      // fallback
      showToast("Org PDF export not available here. Try Dashboard PDF.", "warning");
      return exportDashboardPDF();
    };

</script>
  
  <!-- Load your app logic -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script type="module" src="./script.js"></script>
<script>
    function loadActivityFeed(){
      const feed=document.getElementById('activityFeed');
      if(!feed) return;
      feed.innerHTML='<div class="subtext">No recent activity yet.</div>';
    }
    async function loadOrgOverview(){
      const box=document.getElementById('orgOverview');
      if(!box) return;
      box.innerHTML='<div class="subtext">Select an organization to view details.</div>';
    }
  </script>

<script>
/* ======================================================
   DASHBOARD_AGGREGATION_HELPERS
   Uses Firestore aggregation count() when available.
   Falls back to .get().size if not supported.
   ====================================================== */
async function _safeCount(q){
  try{
    // Firestore v9 compat supports: query.count().get()
    if(q && typeof q.count === "function"){
      const snap = await q.count().get();
      const data = snap && typeof snap.data === "function" ? snap.data() : null;
      if(data && typeof data.count === "number") return data.count;
    }
  }catch(e){
    // ignore and fallback
  }
  try{
    const snap = await q.get();
    return snap.size || 0;
  }catch(e){
    console.warn("Count failed", e);
    return 0;
  }
}

async function _orgCountsAgg(firestore, orgId){
  const base = firestore.collection("organizations").doc(orgId);
  const [voters, votes, positions, candidates] = await Promise.all([
    _safeCount(base.collection("voters")),
    _safeCount(base.collection("votes")),
    _safeCount(base.collection("positions")),
    _safeCount(base.collection("candidates")),
  ]);
  return {voters, votes, positions, candidates};
}
</script>


<script>
/* ======================================================
   GLOBAL DASHBOARD: 100% accurate totals via aggregation
   ====================================================== */
window.__globalTotalsCache = { ts: 0, data: null };
async function computeGlobalTotalsAccurate(){
  const firestore = window.firestore || (window.firebase && firebase.firestore && firebase.firestore()) || null;
  if(!firestore) return { orgs:0, active:0, votesToday:0, voters:0, turnout:0, byHour:[], statusMap:{} };

  const now = Date.now();
  // cache for 20s to reduce reads on rapid tab clicks
  if(window.__globalTotalsCache.data && (now - window.__globalTotalsCache.ts) < 20000){
    return window.__globalTotalsCache.data;
  }

  const orgsSnap = await firestore.collection("organizations").get();
  const orgDocs = orgsSnap.docs || [];
  let totalOrgs = orgDocs.length;
  let totalVoters = 0;
  let totalVotes = 0;
  let activeElections = 0;
  let statusMap = {};

  // Run counts sequentially to avoid rate limits; can be parallel for few orgs.
  for(const d of orgDocs){
    const orgId = d.id;
    const org = d.data() || {};
    const st = String(org.electionStatus || org.status || "unknown").toLowerCase();
    statusMap[st] = (statusMap[st]||0)+1;

    const inProgress = (st==="started"||st==="in_progress"||st==="in progress"||st==="active");
    if(inProgress) activeElections++;

    const c = await _orgCountsAgg(firestore, orgId);
    totalVoters += (c.voters||0);
    totalVotes  += (c.votes||0);
  }

  const turnout = totalVoters ? Math.round((totalVotes/totalVoters)*100) : 0;

  const data = {
    totalOrgs, activeElections, totalVotes, totalVoters, turnout, statusMap
  };
  window.__globalTotalsCache = { ts: now, data };
  return data;
}

// Patch refreshDashboard if present
(function(){
  const wait = () => new Promise(r=>setTimeout(r, 10));
  async function hook(){
    for(let i=0;i<400;i++){
      if(typeof window.refreshDashboard === "function"){
        const original = window.refreshDashboard;
        window.refreshDashboard = async function(){
          try{
            const t = await computeGlobalTotalsAccurate();
            // Fill UI if IDs exist
            const setText = (id,val)=>{ const el=document.getElementById(id); if(el) el.textContent = String(val); };
            setText("statTotalOrganizations", t.totalOrgs);
            setText("statActiveElections", t.activeElections);
            setText("statTotalVotesToday", t.totalVotes); // if you later add "today", update logic
            setText("statTotalVoters", t.totalVoters);
            setText("statAvgTurnout", t.turnout + "%");
            // charts (safe)
            if(typeof window.updateVotesChart === "function") window.updateVotesChart(t);
            if(typeof window.updateElectionStatusChart === "function") window.updateElectionStatusChart(t);
            return;
          }catch(e){
            console.warn("Accurate refresh failed, falling back", e);
          }
          return original.apply(this, arguments);
        };
        return;
      }
      await wait();
    }
  }
  hook();
})();
</script>


<!-- VOTER STATUS VIEW -->
<div id="voterStatusSection" class="hidden">
  <div class="card">
    <h3 id="voterElectionStatus"></h3>
    <div id="voterLiveResults"></div>
  </div>
</div>

  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="./script.js"></script>
</body>
</html>